
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Examples &#8212; bt 0.2.10 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/klink.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="bt Package" href="bt.html" />
    <link rel="prev" title="The Tree Structure" href="tree.html" />
         
        <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
        
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono:400,500,700' rel='stylesheet' type='text/css'>
    
  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h1>
<p>Here are a few examples to give you a better idea of what <strong>bt</strong> is all about.</p>
<div class="section" id="sma-strategy">
<h2>SMA Strategy<a class="headerlink" href="#sma-strategy" title="Permalink to this heading">¶</a></h2>
<p>Let’s start off with a Simple Moving Average (SMA) strategy. We will
start with a simple version of the strategy, namely:</p>
<ul class="simple">
<li><p><strong>Select</strong> the securities that are currently above their 50 day
moving average</p></li>
<li><p><strong>Weigh</strong> each selected security equally</p></li>
<li><p><strong>Rebalance</strong> the portfolio to reflect the target weights</p></li>
</ul>
<p>This should be pretty simple to build. The only thing missing above is
the calculation of the simple moving average. When should this take
place?</p>
<p>Given the flexibility of <strong>bt</strong>, there is no strict rule. The average
calculation could be performed in an Algo, but that would be pretty
inefficient. A better way would be to calculate the moving average at
the beginning - before starting the backtest. After all, all the data is
known in advance.</p>
<p>Now that we know what we have to do, let’s get started. First we will
download some data and calculate the simple moving average.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aapl,msft,c,gs,ge&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>

<span class="c1"># calculate moving average DataFrame using pandas&#39; rolling_mean</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># a rolling mean is a moving average, right?</span>
<span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>It’s always a good idea to plot your data to make sure it looks ok. So
let’s see how the data + sma plot looks like.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s see what the data looks like - this is by no means a pretty chart, but it does the job</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sma</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_6_0.png"><img alt="_images/examples-nb_6_0.png" class="pynb" src="_images/examples-nb_6_0.png" style="width: 879px; height: 305px;" /></a>
<p>Looks legit.</p>
<p>Now that we have our data, we will need to create our security selection
logic. Let’s create a basic Algo that will select the securities that
are above their moving average.</p>
<p>Before we do that, let’s think about how we will code it. We could pass
the SMA data and then extract the row (from the sma DataFrame) on the
current date, compare the values to the current prices, and then keep a
list of those securities where the price is above the SMA. This is the
most straightforward approach. However, this is not very re-usable
because the logic within the Algo will be quite specific to the task at
hand and if we wish to change the logic, we will have to write a new
algo.</p>
<p>For example, what if we wanted to select securities that were below
their sma? Or what if we only wanted securities that were 5% above their
sma?</p>
<p>What we could do instead is pre-calculate the selection logic DataFrame
(a fast, vectorized operation) and write a generic Algo that takes in
this boolean DataFrame and returns the securities where the value is
True on a given date. This will be must faster and much more reusable.
Let’s see how the implementation looks like.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SelectWhere</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Selects securities based on an indicator DataFrame.</span>

<span class="sd">    Selects securities where the value is True on the current date (target.now).</span>

<span class="sd">    Args:</span>
<span class="sd">        * signal (DataFrame): DataFrame containing the signal (boolean DataFrame)</span>

<span class="sd">    Sets:</span>
<span class="sd">        * selected</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># get signal on target.now</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">now</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">now</span><span class="p">]</span>

            <span class="c1"># get indices where true as list</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>

            <span class="c1"># save in temp - this will be used by the weighing algo</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span>

        <span class="c1"># return True because we want to keep on moving down the stack</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>So there we have it. Our selection Algo.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By the way, this Algo already exists - I just wanted to show you how you would code it from scratch.
<a class="reference internal" href="bt.html#bt.algos.SelectWhere" title="bt.algos.SelectWhere"><code class="xref py py-class docutils literal notranslate"><span class="pre">Here</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">code</span></code></a>.</p>
</div>
<p>All we have to do now is pass in a signal matrix. In our case, it’s quite easy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">signal</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span>
</pre></div>
</div>
<p>Simple, concise and more importantly, fast! Let’s move on and test the strategy.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first we create the Strategy</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;above50sma&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="p">),</span>
                               <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                               <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="c1"># now we create the Backtest</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># and let&#39;s run it!</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>So just to recap, we created the strategy, created the backtest by joining Strategy+Data, and ran the backtest. Let’s see the results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># what does the equity curve look like?</span>
<span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_12_0.png"><img alt="_images/examples-nb_12_0.png" class="pynb" src="_images/examples-nb_12_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and some performance stats</span>
<span class="n">res</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stat</span>                 <span class="n">above50sma</span>
 <span class="o">-------------------</span>  <span class="o">------------</span>
 <span class="n">Start</span>                <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>
 <span class="n">End</span>                  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>
 <span class="n">Risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span>       <span class="mf">0.00</span><span class="o">%</span>

 <span class="n">Total</span> <span class="n">Return</span>         <span class="mf">116.08</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.42</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.63</span>
 <span class="n">CAGR</span>                 <span class="mf">6.36</span><span class="o">%</span>
 <span class="n">Max</span> <span class="n">Drawdown</span>         <span class="o">-</span><span class="mf">39.43</span><span class="o">%</span>
 <span class="n">Calmar</span> <span class="n">Ratio</span>         <span class="mf">0.16</span>

 <span class="n">MTD</span>                  <span class="mf">0.00</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">19.50</span><span class="o">%</span>
 <span class="mi">6</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">26.03</span><span class="o">%</span>
 <span class="n">YTD</span>                  <span class="o">-</span><span class="mf">26.03</span><span class="o">%</span>
 <span class="mi">1</span><span class="n">Y</span>                   <span class="o">-</span><span class="mf">22.10</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">10.34</span><span class="o">%</span>
 <span class="mi">5</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">1.89</span><span class="o">%</span>
 <span class="mi">10</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>           <span class="mf">8.70</span><span class="o">%</span>
 <span class="n">Since</span> <span class="n">Incep</span><span class="o">.</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">6.36</span><span class="o">%</span>

 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.42</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.63</span>
 <span class="n">Daily</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>    <span class="mf">8.07</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>     <span class="mf">19.45</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Skew</span>           <span class="o">-</span><span class="mf">0.65</span>
 <span class="n">Daily</span> <span class="n">Kurt</span>           <span class="mf">4.74</span>
 <span class="n">Best</span> <span class="n">Day</span>             <span class="mf">5.78</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Day</span>            <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>

 <span class="n">Monthly</span> <span class="n">Sharpe</span>       <span class="mf">0.39</span>
 <span class="n">Monthly</span> <span class="n">Sortino</span>      <span class="mf">0.65</span>
 <span class="n">Monthly</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">8.59</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>   <span class="mf">21.86</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Skew</span>         <span class="o">-</span><span class="mf">0.37</span>
 <span class="n">Monthly</span> <span class="n">Kurt</span>         <span class="mf">0.73</span>
 <span class="n">Best</span> <span class="n">Month</span>           <span class="mf">21.65</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Month</span>          <span class="o">-</span><span class="mf">17.26</span><span class="o">%</span>

 <span class="n">Yearly</span> <span class="n">Sharpe</span>        <span class="mf">0.41</span>
 <span class="n">Yearly</span> <span class="n">Sortino</span>       <span class="mf">0.83</span>
 <span class="n">Yearly</span> <span class="n">Mean</span>          <span class="mf">9.78</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Vol</span>           <span class="mf">23.65</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Skew</span>          <span class="o">-</span><span class="mf">0.88</span>
 <span class="n">Yearly</span> <span class="n">Kurt</span>          <span class="o">-</span><span class="mf">0.67</span>
 <span class="n">Best</span> <span class="n">Year</span>            <span class="mf">34.85</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Year</span>           <span class="o">-</span><span class="mf">34.38</span><span class="o">%</span>

 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span>        <span class="o">-</span><span class="mf">3.56</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span> <span class="n">Days</span>   <span class="mf">47.27</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Up</span> <span class="n">Month</span>        <span class="mf">4.76</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Down</span> <span class="n">Month</span>      <span class="o">-</span><span class="mf">5.35</span><span class="o">%</span>
 <span class="n">Win</span> <span class="n">Year</span> <span class="o">%</span>           <span class="mf">66.67</span><span class="o">%</span>
 <span class="n">Win</span> <span class="mi">12</span><span class="n">m</span> <span class="o">%</span>            <span class="mf">67.14</span><span class="o">%</span>
</pre></div>
</div>
<p>Nothing stellar but at least you learnt something along the way (I
hope).</p>
<p>Oh, and one more thing. If you were to write your own “library” of
backtests, you might want to write yourself a helper function that would
allow you to test different parameters and securities. That function
might look something like this:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;above_sma&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Long securities that are above their n period</span>
<span class="sd">    Simple Moving Averages with equal weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># download data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="c1"># calc sma</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">sma_per</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># create strategy</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="p">),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

    <span class="c1"># now we create the backtest</span>
    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>This function allows us to easily generate backtests. We could easily
compare a few different SMA periods. Also, let’s see if we can beat a
long-only allocation to the SPY.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple backtest to test long-only allocation</span>
<span class="k">def</span> <span class="nf">long_only_ew</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;long_only_ew&#39;</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunOnce</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># create the backtests</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;aapl,msft,c,gs,ge&#39;</span>
<span class="n">sma10</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma10&#39;</span><span class="p">)</span>
<span class="n">sma20</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma20&#39;</span><span class="p">)</span>
<span class="n">sma40</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma40&#39;</span><span class="p">)</span>
<span class="n">benchmark</span> <span class="o">=</span> <span class="n">long_only_ew</span><span class="p">(</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">)</span>

<span class="c1"># run all the backtests!</span>
<span class="n">res2</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sma10</span><span class="p">,</span> <span class="n">sma20</span><span class="p">,</span> <span class="n">sma40</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">);</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_18_0.png"><img alt="_images/examples-nb_18_0.png" class="pynb" src="_images/examples-nb_18_0.png" style="width: 879px; height: 320px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stat</span>                 <span class="n">sma10</span>       <span class="n">sma20</span>       <span class="n">sma40</span>       <span class="n">spy</span>
 <span class="o">-------------------</span>  <span class="o">----------</span>  <span class="o">----------</span>  <span class="o">----------</span>  <span class="o">----------</span>
 <span class="n">Start</span>                <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>
 <span class="n">End</span>                  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>
 <span class="n">Risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>

 <span class="n">Total</span> <span class="n">Return</span>         <span class="mf">284.16</span><span class="o">%</span>     <span class="mf">229.80</span><span class="o">%</span>     <span class="mf">145.62</span><span class="o">%</span>     <span class="mf">321.22</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.63</span>        <span class="mf">0.58</span>        <span class="mf">0.47</span>        <span class="mf">0.75</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.99</span>        <span class="mf">0.91</span>        <span class="mf">0.73</span>        <span class="mf">1.15</span>
 <span class="n">CAGR</span>                 <span class="mf">11.38</span><span class="o">%</span>      <span class="mf">10.03</span><span class="o">%</span>      <span class="mf">7.46</span><span class="o">%</span>       <span class="mf">12.20</span><span class="o">%</span>
 <span class="n">Max</span> <span class="n">Drawdown</span>         <span class="o">-</span><span class="mf">31.77</span><span class="o">%</span>     <span class="o">-</span><span class="mf">40.72</span><span class="o">%</span>     <span class="o">-</span><span class="mf">34.93</span><span class="o">%</span>     <span class="o">-</span><span class="mf">33.72</span><span class="o">%</span>
 <span class="n">Calmar</span> <span class="n">Ratio</span>         <span class="mf">0.36</span>        <span class="mf">0.25</span>        <span class="mf">0.21</span>        <span class="mf">0.36</span>

 <span class="n">MTD</span>                  <span class="o">-</span><span class="mf">0.76</span><span class="o">%</span>      <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="o">-</span><span class="mf">0.37</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">10.58</span><span class="o">%</span>     <span class="o">-</span><span class="mf">22.25</span><span class="o">%</span>     <span class="o">-</span><span class="mf">18.82</span><span class="o">%</span>     <span class="o">-</span><span class="mf">16.66</span><span class="o">%</span>
 <span class="mi">6</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">10.71</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.14</span><span class="o">%</span>     <span class="o">-</span><span class="mf">30.31</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>
 <span class="n">YTD</span>                  <span class="o">-</span><span class="mf">10.71</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.14</span><span class="o">%</span>     <span class="o">-</span><span class="mf">30.31</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>
 <span class="mi">1</span><span class="n">Y</span>                   <span class="o">-</span><span class="mf">13.63</span><span class="o">%</span>     <span class="o">-</span><span class="mf">24.65</span><span class="o">%</span>     <span class="o">-</span><span class="mf">27.20</span><span class="o">%</span>     <span class="o">-</span><span class="mf">11.44</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">28.10</span><span class="o">%</span>      <span class="mf">14.77</span><span class="o">%</span>      <span class="mf">3.73</span><span class="o">%</span>       <span class="mf">10.10</span><span class="o">%</span>
 <span class="mi">5</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">15.80</span><span class="o">%</span>      <span class="mf">8.37</span><span class="o">%</span>       <span class="mf">1.96</span><span class="o">%</span>       <span class="mf">11.11</span><span class="o">%</span>
 <span class="mi">10</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>           <span class="mf">13.76</span><span class="o">%</span>      <span class="mf">10.96</span><span class="o">%</span>      <span class="mf">9.67</span><span class="o">%</span>       <span class="mf">12.78</span><span class="o">%</span>
 <span class="n">Since</span> <span class="n">Incep</span><span class="o">.</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">11.38</span><span class="o">%</span>      <span class="mf">10.03</span><span class="o">%</span>      <span class="mf">7.46</span><span class="o">%</span>       <span class="mf">12.20</span><span class="o">%</span>

 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.63</span>        <span class="mf">0.58</span>        <span class="mf">0.47</span>        <span class="mf">0.75</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.99</span>        <span class="mf">0.91</span>        <span class="mf">0.73</span>        <span class="mf">1.15</span>
 <span class="n">Daily</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>    <span class="mf">12.88</span><span class="o">%</span>      <span class="mf">11.52</span><span class="o">%</span>      <span class="mf">9.01</span><span class="o">%</span>       <span class="mf">13.03</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>     <span class="mf">20.48</span><span class="o">%</span>      <span class="mf">19.79</span><span class="o">%</span>      <span class="mf">18.97</span><span class="o">%</span>      <span class="mf">17.34</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Skew</span>           <span class="o">-</span><span class="mf">0.11</span>       <span class="o">-</span><span class="mf">0.29</span>       <span class="o">-</span><span class="mf">0.45</span>       <span class="o">-</span><span class="mf">0.59</span>
 <span class="n">Daily</span> <span class="n">Kurt</span>           <span class="mf">6.61</span>        <span class="mf">6.23</span>        <span class="mf">4.32</span>        <span class="mf">11.75</span>
 <span class="n">Best</span> <span class="n">Day</span>             <span class="mf">10.47</span><span class="o">%</span>      <span class="mf">10.47</span><span class="o">%</span>      <span class="mf">6.20</span><span class="o">%</span>       <span class="mf">9.06</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Day</span>            <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">10.94</span><span class="o">%</span>

 <span class="n">Monthly</span> <span class="n">Sharpe</span>       <span class="mf">0.65</span>        <span class="mf">0.54</span>        <span class="mf">0.43</span>        <span class="mf">0.92</span>
 <span class="n">Monthly</span> <span class="n">Sortino</span>      <span class="mf">1.18</span>        <span class="mf">1.02</span>        <span class="mf">0.75</span>        <span class="mf">1.62</span>
 <span class="n">Monthly</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">13.56</span><span class="o">%</span>      <span class="mf">11.95</span><span class="o">%</span>      <span class="mf">9.71</span><span class="o">%</span>       <span class="mf">13.00</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>   <span class="mf">20.96</span><span class="o">%</span>      <span class="mf">21.94</span><span class="o">%</span>      <span class="mf">22.42</span><span class="o">%</span>      <span class="mf">14.20</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Skew</span>         <span class="o">-</span><span class="mf">0.02</span>       <span class="mf">0.22</span>        <span class="o">-</span><span class="mf">0.10</span>       <span class="o">-</span><span class="mf">0.40</span>
 <span class="n">Monthly</span> <span class="n">Kurt</span>         <span class="mf">1.01</span>        <span class="mf">1.11</span>        <span class="mf">0.67</span>        <span class="mf">0.89</span>
 <span class="n">Best</span> <span class="n">Month</span>           <span class="mf">22.75</span><span class="o">%</span>      <span class="mf">24.73</span><span class="o">%</span>      <span class="mf">21.97</span><span class="o">%</span>      <span class="mf">12.70</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Month</span>          <span class="o">-</span><span class="mf">16.94</span><span class="o">%</span>     <span class="o">-</span><span class="mf">14.34</span><span class="o">%</span>     <span class="o">-</span><span class="mf">15.86</span><span class="o">%</span>     <span class="o">-</span><span class="mf">12.49</span><span class="o">%</span>

 <span class="n">Yearly</span> <span class="n">Sharpe</span>        <span class="mf">0.54</span>        <span class="mf">0.43</span>        <span class="mf">0.40</span>        <span class="mf">0.80</span>
 <span class="n">Yearly</span> <span class="n">Sortino</span>       <span class="mf">2.01</span>        <span class="mf">1.03</span>        <span class="mf">0.77</span>        <span class="mf">2.15</span>
 <span class="n">Yearly</span> <span class="n">Mean</span>          <span class="mf">13.38</span><span class="o">%</span>      <span class="mf">13.94</span><span class="o">%</span>      <span class="mf">9.76</span><span class="o">%</span>       <span class="mf">12.67</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Vol</span>           <span class="mf">24.64</span><span class="o">%</span>      <span class="mf">32.80</span><span class="o">%</span>      <span class="mf">24.22</span><span class="o">%</span>      <span class="mf">15.79</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Skew</span>          <span class="mf">0.41</span>        <span class="o">-</span><span class="mf">0.15</span>       <span class="o">-</span><span class="mf">0.87</span>       <span class="o">-</span><span class="mf">0.68</span>
 <span class="n">Yearly</span> <span class="n">Kurt</span>          <span class="o">-</span><span class="mf">0.43</span>       <span class="o">-</span><span class="mf">0.96</span>       <span class="o">-</span><span class="mf">0.59</span>       <span class="mf">0.12</span>
 <span class="n">Best</span> <span class="n">Year</span>            <span class="mf">62.47</span><span class="o">%</span>      <span class="mf">66.99</span><span class="o">%</span>      <span class="mf">39.35</span><span class="o">%</span>      <span class="mf">32.31</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Year</span>           <span class="o">-</span><span class="mf">18.59</span><span class="o">%</span>     <span class="o">-</span><span class="mf">37.01</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.06</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>

 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span>        <span class="o">-</span><span class="mf">3.95</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.49</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.68</span><span class="o">%</span>      <span class="o">-</span><span class="mf">1.69</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span> <span class="n">Days</span>   <span class="mf">40.43</span>       <span class="mf">35.12</span>       <span class="mf">48.79</span>       <span class="mf">15.92</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Up</span> <span class="n">Month</span>        <span class="mf">4.68</span><span class="o">%</span>       <span class="mf">5.00</span><span class="o">%</span>       <span class="mf">4.69</span><span class="o">%</span>       <span class="mf">3.20</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Down</span> <span class="n">Month</span>      <span class="o">-</span><span class="mf">5.00</span><span class="o">%</span>      <span class="o">-</span><span class="mf">4.85</span><span class="o">%</span>      <span class="o">-</span><span class="mf">5.70</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.56</span><span class="o">%</span>
 <span class="n">Win</span> <span class="n">Year</span> <span class="o">%</span>           <span class="mf">58.33</span><span class="o">%</span>      <span class="mf">66.67</span><span class="o">%</span>      <span class="mf">75.00</span><span class="o">%</span>      <span class="mf">83.33</span><span class="o">%</span>
 <span class="n">Win</span> <span class="mi">12</span><span class="n">m</span> <span class="o">%</span>            <span class="mf">68.57</span><span class="o">%</span>      <span class="mf">66.43</span><span class="o">%</span>      <span class="mf">69.29</span><span class="o">%</span>      <span class="mf">91.43</span><span class="o">%</span>
</pre></div>
</div>
<p>And there you have it. Beating the market ain’t that easy!</p>
</div>
<div class="section" id="sma-crossover-strategy">
<h2>SMA Crossover Strategy<a class="headerlink" href="#sma-crossover-strategy" title="Permalink to this heading">¶</a></h2>
<p>Let’s build on the last section to test a moving average crossover
strategy. The easiest way to achieve this is to build an Algo similar to
SelectWhere, but for the purpose of setting target weights. Let’s call
this algo WeighTarget. This algo will take a DataFrame of target weights
that we will pre-calculate.</p>
<p>Basically, when the 50 day moving average will be above the 200-day
moving average, we will be long (+1 target weight). Conversely, when the
50 is below the 200, we will be short (-1 target weight).</p>
<p>Here’s the WeighTarget implementation (this Algo also already exists in
the algos module):</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WeighTarget</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets target weights based on a target weight DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        * target_weights (DataFrame): DataFrame containing the target weights</span>

<span class="sd">    Sets:</span>
<span class="sd">        * weights</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw</span> <span class="o">=</span> <span class="n">target_weights</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># get target weights on date target.now</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">now</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">now</span><span class="p">]</span>

            <span class="c1"># save in temp - this will be used by the weighing algo</span>
            <span class="c1"># also dropping any na&#39;s just in case they pop up</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># return True because we want to keep on moving down the stack</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>So let’s start with a simple 50-200 day sma crossover for a single
security.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## download some data &amp; calc SMAs</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>
<span class="n">sma50</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sma200</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1">## now we need to calculate our target weight DataFrame</span>
<span class="c1"># first we will copy the sma200 DataFrame since our weights will have the same strucutre</span>
<span class="n">tw</span> <span class="o">=</span> <span class="n">sma200</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># set appropriate target weights</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma50</span> <span class="o">&gt;</span> <span class="n">sma200</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma50</span> <span class="o">&lt;=</span> <span class="n">sma200</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="c1"># here we will set the weight to 0 - this is because the sma200 needs 200 data points before</span>
<span class="c1"># calculating its first point. Therefore, it will start with a bunch of nulls (NaNs).</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma200</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>Ok so we downloaded our data, calculated the simple moving averages, and
then we setup our target weight (tw) DataFrame. Let’s take a look at our
target weights to see if they make any sense.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the target weights + chart of price &amp; SMAs</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sma50</span><span class="p">,</span> <span class="n">sma200</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tw&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sma50&#39;</span><span class="p">,</span> <span class="s1">&#39;sma200&#39;</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">secondary_y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tw&#39;</span><span class="p">])</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_26_0.png"><img alt="_images/examples-nb_26_0.png" class="pynb" src="_images/examples-nb_26_0.png" style="width: 916px; height: 305px;" /></a>
<p>As mentioned earlier, it’s always a good idea to plot your strategy
data. It is usually easier to spot logic/programming errors this way,
especially when dealing with lots of data.</p>
<p>Now let’s move on with the Strategy &amp; Backtest.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ma_cross</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;ma_cross&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">WeighTarget</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span>
                                    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">ma_cross</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_29_0.png"><img alt="_images/examples-nb_29_0.png" class="pynb" src="_images/examples-nb_29_0.png" style="width: 879px; height: 304px;" /></a>
<p>Ok great so there we have our basic moving average crossover strategy.</p>
</div>
<div class="section" id="exploring-the-tree-structure">
<h2>Exploring the Tree Structure<a class="headerlink" href="#exploring-the-tree-structure" title="Permalink to this heading">¶</a></h2>
<p>So far, we have explored strategies that allocate capital to securities.
But what if we wanted to test a strategy that allocated capital to
sub-strategies?</p>
<p>The most straightforward way would be to test the different
sub-strategies, extract their equity curves and create “synthetic
securities” that would basically just represent the returns achieved
from allocating capital to the different sub-strategies.</p>
<p>Let’s see how this looks:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first let&#39;s create a helper function to create a ma cross backtest</span>
<span class="k">def</span> <span class="nf">ma_cross</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span>
             <span class="n">short_ma</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">long_ma</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ma_cross&#39;</span><span class="p">):</span>
    <span class="c1"># these are all the same steps as above</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="n">short_sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">short_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">long_sma</span>  <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">long_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># target weights</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">long_sma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">short_sma</span> <span class="o">&gt;</span> <span class="n">long_sma</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">short_sma</span> <span class="o">&lt;=</span> <span class="n">long_sma</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">long_sma</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># here we specify the children (3rd) arguemnt to make sure the strategy</span>
    <span class="c1"># has the proper universe. This is necessary in strategies of strategies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">WeighTarget</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()],</span> <span class="p">[</span><span class="n">ticker</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># ok now let&#39;s create a few backtests and gather the results.</span>
<span class="c1"># these will later become our &quot;synthetic securities&quot;</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;aapl&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;msft&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">)</span>

<span class="c1"># let&#39;s run these strategies now</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

<span class="c1"># now that we have run the strategies, let&#39;s extract</span>
<span class="c1"># the data to create &quot;synthetic securities&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

<span class="c1"># now we have our new data. This data is basically the equity</span>
<span class="c1"># curves of both backtested strategies. Now we can just use this</span>
<span class="c1"># to test any old strategy, just like before.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="c1"># create and run</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_32_0.png"><img alt="_images/examples-nb_32_0.png" class="pynb" src="_images/examples-nb_32_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_weights</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_33_0.png"><img alt="_images/examples-nb_33_0.png" class="pynb" src="_images/examples-nb_33_0.png" style="width: 876px; height: 289px;" /></a>
<p>As we can see above, the process is a bit more involved, but it works.
It is not very elegant though, and obtaining security-level allocation
information is problematic.</p>
<p>Luckily, bt has built-in functionality for dealing with strategies of
strategies. It uses the same general principal as demonstrated above but
does it seamlessly. Basically, when a strategy is a child of another
strategy, it will create a “paper trade” version of itself internally.
As we run our strategy, it will run its internal “paper version” and use
the returns from that strategy to populate the <strong>price</strong> property.</p>
<p>This means that the parent strategy can use the price information (which
reflects the returns of the strategy had it been employed) to determine
the appropriate allocation. Again, this is basically the same process as
above, just packed into 1 step.</p>
<p>Perhaps some code will help:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># once again, we will create a few backtests</span>
<span class="c1"># these will be the child strategies</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;aapl&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;msft&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">)</span>

<span class="c1"># let&#39;s extract the data object</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># now we create the parent strategy</span>
<span class="c1"># we specify the children to be the two</span>
<span class="c1"># strategies created above</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()],</span>
                <span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">strategy</span><span class="p">])</span>

<span class="c1"># create and run</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_36_0.png"><img alt="_images/examples-nb_36_0.png" class="pynb" src="_images/examples-nb_36_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_weights</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_37_0.png"><img alt="_images/examples-nb_37_0.png" class="pynb" src="_images/examples-nb_37_0.png" style="width: 888px; height: 289px;" /></a>
<p>So there you have it. Simpler, and more complete.</p>
</div>
<div class="section" id="buy-and-hold-strategy">
<h2>Buy and Hold Strategy<a class="headerlink" href="#buy-and-hold-strategy" title="Permalink to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">ffn</span>
<span class="kn">import</span> <span class="nn">bt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="section" id="create-fake-index-data">
<h3>Create Fake Index Data<a class="headerlink" href="#create-fake-index-data" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2017-01-01&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2017-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
<span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mf">0.04</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">pdf</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rdf</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Buy_and_hold_3_0.png"><img alt="_images/Buy_and_hold_3_0.png" class="pynb" src="_images/Buy_and_hold_3_0.png" style="width: 377px; height: 262px;" /></a>
</div>
<div class="section" id="build-strategy">
<h3>Build Strategy<a class="headerlink" href="#build-strategy" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># algo to fire on the beginning of every month and to run on the first date</span>
<span class="n">runMonthlyAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(</span>
    <span class="n">run_on_first_date</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># algo to set the weights</span>
<span class="c1">#  it will only run when runMonthlyAlgo returns true</span>
<span class="c1">#  which only happens on the first of every month</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="n">index</span> <span class="o">=</span> <span class="n">rdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">weighSpecifiedAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighSpecified</span><span class="p">(</span><span class="o">**</span><span class="n">weights</span><span class="p">)</span>

<span class="c1"># algo to rebalance the current weights to weights set by weighSpecified</span>
<span class="c1">#  will only run when weighSpecifiedAlgo returns true</span>
<span class="c1">#  which happens every time it runs</span>
<span class="n">rebalAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="c1"># a strategy that rebalances monthly to specified weights</span>
<span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">runMonthlyAlgo</span><span class="p">,</span>
        <span class="n">weighSpecifiedAlgo</span><span class="p">,</span>
        <span class="n">rebalAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="run-backtest">
<h3>Run Backtest<a class="headerlink" href="#run-backtest" title="Permalink to this heading">¶</a></h3>
<p>Note: The logic of the strategy is seperate from the data used in the
backtest.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set integer_positions=False when positions are not required to be integers(round numbers)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">stats</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>static</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>start</th>
      <td>2017-01-01 00:00:00</td>
    </tr>
    <tr>
      <th>end</th>
      <td>2017-12-29 00:00:00</td>
    </tr>
    <tr>
      <th>rf</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>total_return</th>
      <td>0.229372</td>
    </tr>
    <tr>
      <th>cagr</th>
      <td>0.231653</td>
    </tr>
    <tr>
      <th>max_drawdown</th>
      <td>-0.069257</td>
    </tr>
    <tr>
      <th>calmar</th>
      <td>3.344851</td>
    </tr>
    <tr>
      <th>mtd</th>
      <td>-0.000906</td>
    </tr>
    <tr>
      <th>three_month</th>
      <td>0.005975</td>
    </tr>
    <tr>
      <th>six_month</th>
      <td>0.142562</td>
    </tr>
    <tr>
      <th>ytd</th>
      <td>0.229372</td>
    </tr>
    <tr>
      <th>one_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>three_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>five_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>ten_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>incep</th>
      <td>0.231653</td>
    </tr>
    <tr>
      <th>daily_sharpe</th>
      <td>1.804549</td>
    </tr>
    <tr>
      <th>daily_sortino</th>
      <td>3.306154</td>
    </tr>
    <tr>
      <th>daily_mean</th>
      <td>0.206762</td>
    </tr>
    <tr>
      <th>daily_vol</th>
      <td>0.114578</td>
    </tr>
    <tr>
      <th>daily_skew</th>
      <td>0.012208</td>
    </tr>
    <tr>
      <th>daily_kurt</th>
      <td>-0.04456</td>
    </tr>
    <tr>
      <th>best_day</th>
      <td>0.020402</td>
    </tr>
    <tr>
      <th>worst_day</th>
      <td>-0.0201</td>
    </tr>
    <tr>
      <th>monthly_sharpe</th>
      <td>2.806444</td>
    </tr>
    <tr>
      <th>monthly_sortino</th>
      <td>15.352486</td>
    </tr>
    <tr>
      <th>monthly_mean</th>
      <td>0.257101</td>
    </tr>
    <tr>
      <th>monthly_vol</th>
      <td>0.091611</td>
    </tr>
    <tr>
      <th>monthly_skew</th>
      <td>0.753881</td>
    </tr>
    <tr>
      <th>monthly_kurt</th>
      <td>0.456278</td>
    </tr>
    <tr>
      <th>best_month</th>
      <td>0.073657</td>
    </tr>
    <tr>
      <th>worst_month</th>
      <td>-0.014592</td>
    </tr>
    <tr>
      <th>yearly_sharpe</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>yearly_sortino</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>yearly_mean</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>yearly_vol</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>yearly_skew</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>yearly_kurt</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>best_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>worst_year</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>avg_drawdown</th>
      <td>-0.016052</td>
    </tr>
    <tr>
      <th>avg_drawdown_days</th>
      <td>12.695652</td>
    </tr>
    <tr>
      <th>avg_up_month</th>
      <td>0.03246</td>
    </tr>
    <tr>
      <th>avg_down_month</th>
      <td>-0.008001</td>
    </tr>
    <tr>
      <th>win_year_perc</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>twelve_month_win_perc</th>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>static</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01</th>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>2017-01-02</th>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>2017-01-03</th>
      <td>99.384719</td>
    </tr>
    <tr>
      <th>2017-01-04</th>
      <td>99.121677</td>
    </tr>
    <tr>
      <th>2017-01-05</th>
      <td>98.316364</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_security_weights</span><span class="p">()</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Buy_and_hold_10_0.png"><img alt="_images/Buy_and_hold_10_0.png" class="pynb" src="_images/Buy_and_hold_10_0.png" style="width: 876px; height: 297px;" /></a>
<p>Strategy value over time</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performanceStats</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;static&#39;</span><span class="p">]</span>
<span class="c1">#performance stats is an ffn object</span>
<span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Buy_and_hold_12_0.png"><img alt="_images/Buy_and_hold_12_0.png" class="pynb" src="_images/Buy_and_hold_12_0.png" style="width: 380px; height: 259px;" /></a>
<p>Strategy Outlays</p>
<p>Outlays are the total dollar amount spent(gained) by a purchase(sale) of
securities.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">outlays</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Buy_and_hold_14_0.png"><img alt="_images/Buy_and_hold_14_0.png" class="pynb" src="_images/Buy_and_hold_14_0.png" style="width: 395px; height: 248px;" /></a>
<p>You can get the change in number of shares purchased a</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">security_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">outlays</span><span class="o">.</span><span class="n">columns</span>


<span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">outlays</span><span class="o">/</span><span class="n">pdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">security_names</span><span class="p">]</span>
<span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">backtest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
      <th>bar</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01</th>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2017-01-02</th>
      <td>5879.285683</td>
      <td>3998.068018</td>
    </tr>
    <tr>
      <th>2017-01-03</th>
      <td>5879.285683</td>
      <td>3998.068018</td>
    </tr>
    <tr>
      <th>2017-01-04</th>
      <td>5879.285683</td>
      <td>3998.068018</td>
    </tr>
    <tr>
      <th>2017-01-05</th>
      <td>5879.285683</td>
      <td>3998.068018</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2017-12-25</th>
      <td>5324.589093</td>
      <td>4673.239436</td>
    </tr>
    <tr>
      <th>2017-12-26</th>
      <td>5324.589093</td>
      <td>4673.239436</td>
    </tr>
    <tr>
      <th>2017-12-27</th>
      <td>5324.589093</td>
      <td>4673.239436</td>
    </tr>
    <tr>
      <th>2017-12-28</th>
      <td>5324.589093</td>
      <td>4673.239436</td>
    </tr>
    <tr>
      <th>2017-12-29</th>
      <td>5324.589093</td>
      <td>4673.239436</td>
    </tr>
  </tbody>
</table>
<p>261 rows × 2 columns</p>
</div></div>
</div>
<div class="section" id="trend-example-1">
<h2>Trend Example 1<a class="headerlink" href="#trend-example-1" title="Permalink to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">ffn</span>
<span class="kn">import</span> <span class="nn">bt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="section" id="create-fake-data">
<h3>Create fake data<a class="headerlink" href="#create-fake-data" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="mf">0.04</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">rf</span>
<span class="n">sigmas</span> <span class="o">=</span> <span class="p">(</span><span class="n">mus</span> <span class="o">-</span> <span class="n">rf</span><span class="p">)</span><span class="o">/</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">num_years</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_months_per_year</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">num_days_per_month</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">num_days_per_year</span> <span class="o">=</span> <span class="n">num_months_per_year</span><span class="o">*</span><span class="n">num_days_per_month</span>

<span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2008-01-02&quot;</span><span class="p">,</span>
        <span class="n">periods</span><span class="o">=</span><span class="n">num_years</span><span class="o">*</span><span class="n">num_months_per_year</span><span class="o">*</span><span class="n">num_days_per_month</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;B&quot;</span>
    <span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span><span class="s1">&#39;fake1&#39;</span><span class="p">,</span><span class="s1">&#39;fake2&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mus</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">rdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="o">/</span><span class="n">num_days_per_year</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_days_per_year</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="n">rdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rdf</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Trend_1_3_0.png"><img alt="_images/Trend_1_3_0.png" class="pynb" src="_images/Trend_1_3_0.png" style="width: 376px; height: 251px;" /></a>
</div>
<div class="section" id="create-trend-signal-over-the-last-12-months">
<h3>Create Trend signal over the last 12 months<a class="headerlink" href="#create-trend-signal-over-the-last-12-months" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sma</span>  <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">num_days_per_month</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pdf</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sma</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">sma</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Trend_1_5_0.png"><img alt="_images/Trend_1_5_0.png" class="pynb" src="_images/Trend_1_5_0.png" style="width: 384px; height: 251px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#sma with 1 day lag</span>
<span class="n">sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
      <th>bar</th>
      <th>baz</th>
      <th>fake1</th>
      <th>fake2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-08-23</th>
      <td>623.241267</td>
      <td>340.774506</td>
      <td>99.764885</td>
      <td>263.491447</td>
      <td>619.963986</td>
    </tr>
    <tr>
      <th>2017-08-24</th>
      <td>623.167989</td>
      <td>341.096742</td>
      <td>99.764885</td>
      <td>263.502145</td>
      <td>620.979948</td>
    </tr>
    <tr>
      <th>2017-08-25</th>
      <td>622.749149</td>
      <td>341.316672</td>
      <td>99.764885</td>
      <td>263.502145</td>
      <td>622.421401</td>
    </tr>
    <tr>
      <th>2017-08-28</th>
      <td>622.353039</td>
      <td>341.494307</td>
      <td>99.807732</td>
      <td>263.517071</td>
      <td>622.962579</td>
    </tr>
    <tr>
      <th>2017-08-29</th>
      <td>622.153294</td>
      <td>341.662442</td>
      <td>99.807732</td>
      <td>263.517071</td>
      <td>622.992416</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#sma with 0 day lag</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">num_days_per_month</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
      <th>bar</th>
      <th>baz</th>
      <th>fake1</th>
      <th>fake2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-08-23</th>
      <td>623.167989</td>
      <td>341.096742</td>
      <td>99.764885</td>
      <td>263.502145</td>
      <td>620.979948</td>
    </tr>
    <tr>
      <th>2017-08-24</th>
      <td>622.749149</td>
      <td>341.316672</td>
      <td>99.764885</td>
      <td>263.502145</td>
      <td>622.421401</td>
    </tr>
    <tr>
      <th>2017-08-25</th>
      <td>622.353039</td>
      <td>341.494307</td>
      <td>99.807732</td>
      <td>263.517071</td>
      <td>622.962579</td>
    </tr>
    <tr>
      <th>2017-08-28</th>
      <td>622.153294</td>
      <td>341.662442</td>
      <td>99.807732</td>
      <td>263.517071</td>
      <td>622.992416</td>
    </tr>
    <tr>
      <th>2017-08-29</th>
      <td>621.907867</td>
      <td>341.948212</td>
      <td>99.807732</td>
      <td>263.634283</td>
      <td>624.310473</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># target weights</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">sma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">trend</span><span class="p">[</span><span class="n">pdf</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">trend</span><span class="p">[</span><span class="n">pdf</span> <span class="o">&lt;=</span> <span class="n">sma</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">trend</span><span class="p">[</span><span class="n">sma</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">trend</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
      <th>bar</th>
      <th>baz</th>
      <th>fake1</th>
      <th>fake2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-08-23</th>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2017-08-24</th>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2017-08-25</th>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2017-08-28</th>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2017-08-29</th>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div><p>Compare EW and 1/vol</p>
<p>Both strategies rebalance daily using trend with 1 day lag and weights
limited to 40%.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tsmom_invvol_strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;tsmom_invvol&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunDaily</span><span class="p">(),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">trend</span><span class="p">),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">LimitWeights</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">tsmom_ew_strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;tsmom_ew&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunDaily</span><span class="p">(),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">trend</span><span class="p">),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">LimitWeights</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create and run</span>
<span class="n">tsmom_invvol_bt</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">tsmom_invvol_strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">initial_capital</span><span class="o">=</span><span class="mf">50000000.0</span><span class="p">,</span>
    <span class="n">commissions</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0021</span><span class="p">),</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">tsmom_invvol_res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tsmom_invvol_bt</span><span class="p">)</span>

<span class="n">tsmom_ew_bt</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">tsmom_ew_strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>

    <span class="n">initial_capital</span><span class="o">=</span><span class="mf">50000000.0</span><span class="p">,</span>
    <span class="n">commissions</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0021</span><span class="p">),</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">tsmom_ew_res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tsmom_ew_bt</span><span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">tsmom_invvol</span>
 <span class="mi">0</span><span class="o">%</span> <span class="p">[</span><span class="c1">############################# ] 100% | ETA: 00:00:00tsmom_ew</span>
 <span class="mi">0</span><span class="o">%</span> <span class="p">[</span><span class="c1">############################# ] 100% | ETA: 00:00:00</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tsmom_ew_res</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">tsmom_ew_res</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;EW&#39;</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Trend_1_12_0.png"><img alt="_images/Trend_1_12_0.png" class="pynb" src="_images/Trend_1_12_0.png" style="width: 376px; height: 240px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tsmom_ew_res</span><span class="o">.</span><span class="n">stats</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tsmom_ew</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>start</th>
      <td>2008-01-01 00:00:00</td>
    </tr>
    <tr>
      <th>end</th>
      <td>2017-08-29 00:00:00</td>
    </tr>
    <tr>
      <th>rf</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>total_return</th>
      <td>1.982933</td>
    </tr>
    <tr>
      <th>cagr</th>
      <td>0.119797</td>
    </tr>
    <tr>
      <th>max_drawdown</th>
      <td>-0.103421</td>
    </tr>
    <tr>
      <th>calmar</th>
      <td>1.158343</td>
    </tr>
    <tr>
      <th>mtd</th>
      <td>0.017544</td>
    </tr>
    <tr>
      <th>three_month</th>
      <td>0.040722</td>
    </tr>
    <tr>
      <th>six_month</th>
      <td>0.079362</td>
    </tr>
    <tr>
      <th>ytd</th>
      <td>0.08107</td>
    </tr>
    <tr>
      <th>one_year</th>
      <td>0.100432</td>
    </tr>
    <tr>
      <th>three_year</th>
      <td>0.159895</td>
    </tr>
    <tr>
      <th>five_year</th>
      <td>0.172284</td>
    </tr>
    <tr>
      <th>ten_year</th>
      <td>0.119797</td>
    </tr>
    <tr>
      <th>incep</th>
      <td>0.119797</td>
    </tr>
    <tr>
      <th>daily_sharpe</th>
      <td>1.356727</td>
    </tr>
    <tr>
      <th>daily_sortino</th>
      <td>2.332895</td>
    </tr>
    <tr>
      <th>daily_mean</th>
      <td>0.112765</td>
    </tr>
    <tr>
      <th>daily_vol</th>
      <td>0.083116</td>
    </tr>
    <tr>
      <th>daily_skew</th>
      <td>0.029851</td>
    </tr>
    <tr>
      <th>daily_kurt</th>
      <td>0.96973</td>
    </tr>
    <tr>
      <th>best_day</th>
      <td>0.02107</td>
    </tr>
    <tr>
      <th>worst_day</th>
      <td>-0.021109</td>
    </tr>
    <tr>
      <th>monthly_sharpe</th>
      <td>1.373241</td>
    </tr>
    <tr>
      <th>monthly_sortino</th>
      <td>2.966223</td>
    </tr>
    <tr>
      <th>monthly_mean</th>
      <td>0.118231</td>
    </tr>
    <tr>
      <th>monthly_vol</th>
      <td>0.086096</td>
    </tr>
    <tr>
      <th>monthly_skew</th>
      <td>-0.059867</td>
    </tr>
    <tr>
      <th>monthly_kurt</th>
      <td>0.571064</td>
    </tr>
    <tr>
      <th>best_month</th>
      <td>0.070108</td>
    </tr>
    <tr>
      <th>worst_month</th>
      <td>-0.064743</td>
    </tr>
    <tr>
      <th>yearly_sharpe</th>
      <td>1.741129</td>
    </tr>
    <tr>
      <th>yearly_sortino</th>
      <td>inf</td>
    </tr>
    <tr>
      <th>yearly_mean</th>
      <td>0.129033</td>
    </tr>
    <tr>
      <th>yearly_vol</th>
      <td>0.074109</td>
    </tr>
    <tr>
      <th>yearly_skew</th>
      <td>0.990397</td>
    </tr>
    <tr>
      <th>yearly_kurt</th>
      <td>1.973883</td>
    </tr>
    <tr>
      <th>best_year</th>
      <td>0.285249</td>
    </tr>
    <tr>
      <th>worst_year</th>
      <td>0.024152</td>
    </tr>
    <tr>
      <th>avg_drawdown</th>
      <td>-0.015516</td>
    </tr>
    <tr>
      <th>avg_drawdown_days</th>
      <td>25.223214</td>
    </tr>
    <tr>
      <th>avg_up_month</th>
      <td>0.024988</td>
    </tr>
    <tr>
      <th>avg_down_month</th>
      <td>-0.012046</td>
    </tr>
    <tr>
      <th>win_year_perc</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>twelve_month_win_perc</th>
      <td>0.971429</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="trend-example-2">
<h2>Trend Example 2<a class="headerlink" href="#trend-example-2" title="Permalink to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.08</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span><span class="mf">0.2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">12</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">returns</span><span class="p">),</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2008-01-01&quot;</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">12</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Trend_2_2_0.png"><img alt="_images/Trend_2_2_0.png" class="pynb" src="_images/Trend_2_2_0.png" style="width: 373px; height: 251px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runMonthlyAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">()</span>
<span class="n">rebalAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Signal</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Mostly copied from StatTotalReturn</span>

<span class="sd">    Sets temp[&#39;Signal&#39;] with total returns over a given period.</span>

<span class="sd">    Sets the &#39;Signal&#39; based on the total return of each</span>
<span class="sd">    over a given lookback period.</span>

<span class="sd">    Args:</span>
<span class="sd">        * lookback (DateOffset): lookback period.</span>
<span class="sd">        * lag (DateOffset): Lag interval. Total return is calculated in</span>
<span class="sd">            the inteval [now - lookback - lag, now - lag]</span>

<span class="sd">    Sets:</span>
<span class="sd">        * stat</span>

<span class="sd">    Requires:</span>
<span class="sd">        * selected</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                 <span class="n">lag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">)):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag</span> <span class="o">=</span> <span class="n">lag</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lag</span>

        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">universe</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">prc</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">universe</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">t0</span><span class="p">]</span>


        <span class="n">trend</span> <span class="o">=</span> <span class="n">prc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">prc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">trend</span> <span class="o">&gt;</span> <span class="mf">0.</span>

        <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="kc">True</span>

<span class="n">signalAlgo</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">WeighFromSignal</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets temp[&#39;weights&#39;] from the signal.</span>
<span class="sd">    Sets:</span>
<span class="sd">        * weights</span>

<span class="sd">    Requires:</span>
<span class="sd">        * selected</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WeighFromSignal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No Signal!&#39;</span><span class="p">))</span>

        <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">selected</span> <span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="n">weighFromSignalAlgo</span> <span class="o">=</span> <span class="n">WeighFromSignal</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;example1&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">runMonthlyAlgo</span><span class="p">,</span>
        <span class="n">signalAlgo</span><span class="p">,</span>
        <span class="n">weighFromSignalAlgo</span><span class="p">,</span>
        <span class="n">rebalAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">example1</span>
 <span class="mi">0</span><span class="o">%</span> <span class="p">[</span><span class="c1">############################# ] 100% | ETA: 00:00:00</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_security_weights</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Trend_2_5_0.png"><img alt="_images/Trend_2_5_0.png" class="pynb" src="_images/Trend_2_5_0.png" style="width: 876px; height: 289px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">positions</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2008-01-30</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2008-01-31</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2008-02-29</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2008-03-31</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2008-04-30</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2017-08-31</th>
      <td>631321.251898</td>
    </tr>
    <tr>
      <th>2017-09-30</th>
      <td>631321.251898</td>
    </tr>
    <tr>
      <th>2017-10-31</th>
      <td>631321.251898</td>
    </tr>
    <tr>
      <th>2017-11-30</th>
      <td>631321.251898</td>
    </tr>
    <tr>
      <th>2017-12-31</th>
      <td>631321.251898</td>
    </tr>
  </tbody>
</table>
<p>121 rows × 1 columns</p>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>example1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-08-31</th>
      <td>240.302579</td>
    </tr>
    <tr>
      <th>2017-09-30</th>
      <td>255.046653</td>
    </tr>
    <tr>
      <th>2017-10-31</th>
      <td>254.464421</td>
    </tr>
    <tr>
      <th>2017-11-30</th>
      <td>265.182603</td>
    </tr>
    <tr>
      <th>2017-12-31</th>
      <td>281.069771</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">stats</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>example1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>start</th>
      <td>2008-01-30 00:00:00</td>
    </tr>
    <tr>
      <th>end</th>
      <td>2017-12-31 00:00:00</td>
    </tr>
    <tr>
      <th>rf</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>total_return</th>
      <td>1.810698</td>
    </tr>
    <tr>
      <th>cagr</th>
      <td>0.109805</td>
    </tr>
    <tr>
      <th>max_drawdown</th>
      <td>-0.267046</td>
    </tr>
    <tr>
      <th>calmar</th>
      <td>0.411186</td>
    </tr>
    <tr>
      <th>mtd</th>
      <td>0.05991</td>
    </tr>
    <tr>
      <th>three_month</th>
      <td>0.102033</td>
    </tr>
    <tr>
      <th>six_month</th>
      <td>0.22079</td>
    </tr>
    <tr>
      <th>ytd</th>
      <td>0.879847</td>
    </tr>
    <tr>
      <th>one_year</th>
      <td>0.879847</td>
    </tr>
    <tr>
      <th>three_year</th>
      <td>0.406395</td>
    </tr>
    <tr>
      <th>five_year</th>
      <td>0.227148</td>
    </tr>
    <tr>
      <th>ten_year</th>
      <td>0.109805</td>
    </tr>
    <tr>
      <th>incep</th>
      <td>0.109805</td>
    </tr>
    <tr>
      <th>daily_sharpe</th>
      <td>3.299555</td>
    </tr>
    <tr>
      <th>daily_sortino</th>
      <td>6.352869</td>
    </tr>
    <tr>
      <th>daily_mean</th>
      <td>2.448589</td>
    </tr>
    <tr>
      <th>daily_vol</th>
      <td>0.742097</td>
    </tr>
    <tr>
      <th>daily_skew</th>
      <td>0.307861</td>
    </tr>
    <tr>
      <th>daily_kurt</th>
      <td>1.414455</td>
    </tr>
    <tr>
      <th>best_day</th>
      <td>0.137711</td>
    </tr>
    <tr>
      <th>worst_day</th>
      <td>-0.14073</td>
    </tr>
    <tr>
      <th>monthly_sharpe</th>
      <td>0.723148</td>
    </tr>
    <tr>
      <th>monthly_sortino</th>
      <td>1.392893</td>
    </tr>
    <tr>
      <th>monthly_mean</th>
      <td>0.117579</td>
    </tr>
    <tr>
      <th>monthly_vol</th>
      <td>0.162594</td>
    </tr>
    <tr>
      <th>monthly_skew</th>
      <td>0.301545</td>
    </tr>
    <tr>
      <th>monthly_kurt</th>
      <td>1.379006</td>
    </tr>
    <tr>
      <th>best_month</th>
      <td>0.137711</td>
    </tr>
    <tr>
      <th>worst_month</th>
      <td>-0.14073</td>
    </tr>
    <tr>
      <th>yearly_sharpe</th>
      <td>0.503939</td>
    </tr>
    <tr>
      <th>yearly_sortino</th>
      <td>5.019272</td>
    </tr>
    <tr>
      <th>yearly_mean</th>
      <td>0.14814</td>
    </tr>
    <tr>
      <th>yearly_vol</th>
      <td>0.293964</td>
    </tr>
    <tr>
      <th>yearly_skew</th>
      <td>2.317496</td>
    </tr>
    <tr>
      <th>yearly_kurt</th>
      <td>5.894955</td>
    </tr>
    <tr>
      <th>best_year</th>
      <td>0.879847</td>
    </tr>
    <tr>
      <th>worst_year</th>
      <td>-0.088543</td>
    </tr>
    <tr>
      <th>avg_drawdown</th>
      <td>-0.091255</td>
    </tr>
    <tr>
      <th>avg_drawdown_days</th>
      <td>369.714286</td>
    </tr>
    <tr>
      <th>avg_up_month</th>
      <td>0.064341</td>
    </tr>
    <tr>
      <th>avg_down_month</th>
      <td>-0.012928</td>
    </tr>
    <tr>
      <th>win_year_perc</th>
      <td>0.555556</td>
    </tr>
    <tr>
      <th>twelve_month_win_perc</th>
      <td>0.46789</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="strategy-combination">
<h2>Strategy Combination<a class="headerlink" href="#strategy-combination" title="Permalink to this heading">¶</a></h2>
<p>This notebook creates a parent strategy(combined) with 2 child
strategies(Equal Weight, Inv Vol).</p>
<p>Alternatively, it creates the 2 child strategies, runs the backtest,
combines the results, and creates a parent strategy using both of the
backtests.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">ffn</span>
<span class="kn">import</span> <span class="nn">bt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="section" id="id1">
<h3>Create fake data<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="mf">0.04</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">rf</span>
<span class="n">sigmas</span> <span class="o">=</span> <span class="p">(</span><span class="n">mus</span> <span class="o">-</span> <span class="n">rf</span><span class="p">)</span><span class="o">/</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">num_years</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_months_per_year</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">num_days_per_month</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">num_days_per_year</span> <span class="o">=</span> <span class="n">num_months_per_year</span><span class="o">*</span><span class="n">num_days_per_month</span>

<span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2008-01-02&quot;</span><span class="p">,</span>
        <span class="n">periods</span><span class="o">=</span><span class="n">num_years</span><span class="o">*</span><span class="n">num_months_per_year</span><span class="o">*</span><span class="n">num_days_per_month</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;B&quot;</span>
    <span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span><span class="s1">&#39;fake1&#39;</span><span class="p">,</span><span class="s1">&#39;fake2&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mus</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">rdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="o">/</span><span class="n">num_days_per_year</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_days_per_year</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="n">rdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rdf</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_3_0.png"><img alt="_images/Strategy_Combination_3_0.png" class="pynb" src="_images/Strategy_Combination_3_0.png" style="width: 376px; height: 251px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strategy_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s1">&#39;Equal Weight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inv Vol&#39;</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">runMonthlyAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(</span>
    <span class="n">run_on_first_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">run_on_end_of_period</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">selectAllAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">()</span>
<span class="n">rebalanceAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="n">strats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strategy_names</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;Equal Weight&quot;</span><span class="p">:</span>
        <span class="n">wAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;Inv Vol&quot;</span><span class="p">:</span>
        <span class="n">wAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">()</span>

    <span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
        <span class="p">[</span>
            <span class="n">runMonthlyAlgo</span><span class="p">,</span>
            <span class="n">selectAllAlgo</span><span class="p">,</span>
            <span class="n">wAlgo</span><span class="p">,</span>
            <span class="n">rebalanceAlgo</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">strats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strat</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
        <span class="n">strat</span><span class="p">,</span>
        <span class="n">pdf</span><span class="p">,</span>
        <span class="n">integer_positions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;Combined&#39;</span><span class="p">,</span>
    <span class="n">algos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">runMonthlyAlgo</span><span class="p">,</span>
        <span class="n">selectAllAlgo</span><span class="p">,</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
        <span class="n">rebalanceAlgo</span>
    <span class="p">],</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strategy</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">combined_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">combined_strategy</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">integer_positions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">combined_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_6_0.png"><img alt="_images/Strategy_Combination_6_0.png" class="pynb" src="_images/Strategy_Combination_6_0.png" style="width: 376px; height: 251px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_7_0.png"><img alt="_images/Strategy_Combination_7_0.png" class="pynb" src="_images/Strategy_Combination_7_0.png" style="width: 380px; height: 253px;" /></a>
<p>In order to get the weights of each strategy, you can run each strategy,
get the prices for each strategy, combine them into one price dataframe,
run the combined strategy on the new data set.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strategy_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s1">&#39;Equal Weight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inv Vol&#39;</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">runMonthlyAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(</span>
    <span class="n">run_on_first_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">run_on_end_of_period</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">selectAllAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">()</span>
<span class="n">rebalanceAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="n">strats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strategy_names</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;Equal Weight&quot;</span><span class="p">:</span>
        <span class="n">wAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;Inv Vol&quot;</span><span class="p">:</span>
        <span class="n">wAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">()</span>

    <span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
        <span class="n">s</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">runMonthlyAlgo</span><span class="p">,</span>
            <span class="n">selectAllAlgo</span><span class="p">,</span>
            <span class="n">wAlgo</span><span class="p">,</span>
            <span class="n">rebalanceAlgo</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">strats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strat</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
        <span class="n">strat</span><span class="p">,</span>
        <span class="n">pdf</span><span class="p">,</span>
        <span class="n">integer_positions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_10_0.png"><img alt="_images/Strategy_Combination_10_0.png" class="pynb" src="_images/Strategy_Combination_10_0.png" style="width: 879px; height: 320px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">merged_prices_df</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

<span class="n">combined_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;Combined&#39;</span><span class="p">,</span>
    <span class="n">algos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">runMonthlyAlgo</span><span class="p">,</span>
        <span class="n">selectAllAlgo</span><span class="p">,</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
        <span class="n">rebalanceAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">combined_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">combined_strategy</span><span class="p">,</span>
    <span class="n">merged_prices_df</span><span class="p">,</span>
    <span class="n">integer_positions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">combined_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_12_0.png"><img alt="_images/Strategy_Combination_12_0.png" class="pynb" src="_images/Strategy_Combination_12_0.png" style="width: 879px; height: 320px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Strategy_Combination_13_0.png"><img alt="_images/Strategy_Combination_13_0.png" class="pynb" src="_images/Strategy_Combination_13_0.png" style="width: 373px; height: 251px;" /></a>
</div>
</div>
<div class="section" id="equally-weighted-risk-contributions-portfolio">
<h2>Equally Weighted Risk Contributions Portfolio<a class="headerlink" href="#equally-weighted-risk-contributions-portfolio" title="Permalink to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">ffn</span>
<span class="kn">import</span> <span class="nn">bt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="section" id="id2">
<h3>Create Fake Index Data<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="o">/</span><span class="mi">252</span> <span class="o">+</span> <span class="mf">0.02</span><span class="o">/</span><span class="mi">252</span><span class="p">,</span> <span class="mf">0.03</span><span class="o">/</span><span class="mi">252</span> <span class="o">+</span> <span class="mf">0.02</span><span class="o">/</span><span class="mi">252</span><span class="p">])</span>
<span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="mf">0.05</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)])</span>
<span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">volatility</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variance</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variance</span><span class="p">)):</span>
        <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">volatility</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

<span class="n">covariance</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">array</span><span class="p">([[</span><span class="mf">1.58730159e-04</span><span class="p">,</span> <span class="mf">9.92063492e-06</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">9.92063492e-06</span><span class="p">,</span> <span class="mf">9.92063492e-06</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2018-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
<span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="n">covariance</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">/</span><span class="mi">252</span>

<span class="n">pdf</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rdf</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/ERC_4_0.png"><img alt="_images/ERC_4_0.png" class="pynb" src="_images/ERC_4_0.png" style="width: 377px; height: 262px;" /></a>
</div>
<div class="section" id="build-and-run-erc-strategy">
<h3>Build and run ERC Strategy<a class="headerlink" href="#build-and-run-erc-strategy" title="Permalink to this heading">¶</a></h3>
<p>You can read more about ERC here.
<a class="reference external" href="http://thierry-roncalli.com/download/erc.pdf">http://thierry-roncalli.com/download/erc.pdf</a></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runAfterDaysAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunAfterDays</span><span class="p">(</span>
    <span class="mi">20</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="n">selectTheseAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectThese</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">])</span>

<span class="c1"># algo to set the weights so each asset contributes the same amount of risk</span>
<span class="c1">#  with data over the last 6 months excluding yesterday</span>
<span class="n">weighERCAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighERC</span><span class="p">(</span>
    <span class="n">lookback</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="mi">6</span><span class="p">),</span>
    <span class="n">covar_method</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
    <span class="n">risk_parity_method</span><span class="o">=</span><span class="s1">&#39;slsqp&#39;</span><span class="p">,</span>
    <span class="n">maximum_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span>
    <span class="n">lag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">rebalAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;ERC&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">runAfterDaysAlgo</span><span class="p">,</span>
        <span class="n">selectTheseAlgo</span><span class="p">,</span>
        <span class="n">weighERCAlgo</span><span class="p">,</span>
        <span class="n">rebalAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">res_target</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/ERC_7_0.png"><img alt="_images/ERC_7_0.png" class="pynb" src="_images/ERC_7_0.png" style="width: 373px; height: 262px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_target</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/ERC_8_0.png"><img alt="_images/ERC_8_0.png" class="pynb" src="_images/ERC_8_0.png" style="width: 376px; height: 264px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights_target</span> <span class="o">=</span> <span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">rolling_cov_target</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span>


<span class="n">trc_target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">trc_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="p">(</span><span class="n">rolling_cov_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@rolling_cov_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">trc_target</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Risk Contribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/ERC_9_0.png"><img alt="_images/ERC_9_0.png" class="pynb" src="_images/ERC_9_0.png" style="width: 386px; height: 277px;" /></a>
<p>You can see the Total Risk Contribution is roughly equal from both
assets.</p>
</div>
</div>
<div class="section" id="predicted-tracking-error-rebalance-portfolio">
<h2>Predicted Tracking Error Rebalance Portfolio<a class="headerlink" href="#predicted-tracking-error-rebalance-portfolio" title="Permalink to this heading">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">ffn</span>
<span class="kn">import</span> <span class="nn">bt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="section" id="id3">
<h3>Create Fake Index Data<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2018-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
<span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">/</span><span class="mi">252</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mf">0.04</span><span class="o">/</span><span class="mi">252</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rdf</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">pdf</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rdf</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_3_0.png"><img alt="_images/PTE_3_0.png" class="pynb" src="_images/PTE_3_0.png" style="width: 377px; height: 262px;" /></a>
</div>
<div class="section" id="build-and-run-target-strategy">
<h3>Build and run Target Strategy<a class="headerlink" href="#build-and-run-target-strategy" title="Permalink to this heading">¶</a></h3>
<p>I will first run a strategy that rebalances everyday.</p>
<p>Then I will use those weights as target to rebalance to whenever the PTE
is too high.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selectTheseAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectThese</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">])</span>

<span class="c1"># algo to set the weights to 1/vol contributions from each asset</span>
<span class="c1">#  with data over the last 3 months excluding yesterday</span>
<span class="n">weighInvVolAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(</span>
    <span class="n">lookback</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">lag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># algo to rebalance the current weights to weights set in target.temp</span>
<span class="n">rebalAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="c1"># a strategy that rebalances daily to 1/vol weights</span>
<span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;Target&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">selectTheseAlgo</span><span class="p">,</span>
        <span class="n">weighInvVolAlgo</span><span class="p">,</span>
        <span class="n">rebalAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># set integer_positions=False when positions are not required to be integers(round numbers)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">res_target</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_6_0.png"><img alt="_images/PTE_6_0.png" class="pynb" src="_images/PTE_6_0.png" style="width: 373px; height: 262px;" /></a>
<p>Now use the PTE rebalance algo to trigger a rebalance whenever predicted
tracking error is greater than 1%.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># algo to fire whenever predicted tracking error is greater than 1%</span>
<span class="n">wdf</span> <span class="o">=</span> <span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span>

<span class="n">PTE_rebalance_Algo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">PTE_Rebalance</span><span class="p">(</span>
    <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">wdf</span><span class="p">,</span>
    <span class="n">lookback</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">lag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">covar_method</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
    <span class="n">annualization_factor</span><span class="o">=</span><span class="mi">252</span>
<span class="p">)</span>

<span class="n">selectTheseAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectThese</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">])</span>

<span class="c1"># algo to set the weights to 1/vol contributions from each asset</span>
<span class="c1">#  with data over the last 12 months excluding yesterday</span>
<span class="n">weighTargetAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighTarget</span><span class="p">(</span>
    <span class="n">wdf</span>
<span class="p">)</span>

<span class="n">rebalAlgo</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>

<span class="c1"># a strategy that rebalances monthly to specified weights</span>
<span class="n">strat</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span>
    <span class="s1">&#39;PTE&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">PTE_rebalance_Algo</span><span class="p">,</span>
        <span class="n">selectTheseAlgo</span><span class="p">,</span>
        <span class="n">weighTargetAlgo</span><span class="p">,</span>
        <span class="n">rebalAlgo</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># set integer_positions=False when positions are not required to be integers(round numbers)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span>
    <span class="n">strat</span><span class="p">,</span>
    <span class="n">pdf</span><span class="p">,</span>
    <span class="n">integer_positions</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">res_PTE</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">realized_weights_df</span> <span class="o">=</span> <span class="n">res_PTE</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span>
<span class="n">realized_weights_df</span><span class="p">[</span><span class="s1">&#39;PTE foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realized_weights_df</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="n">realized_weights_df</span><span class="p">[</span><span class="s1">&#39;PTE bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realized_weights_df</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span>
<span class="n">realized_weights_df</span> <span class="o">=</span> <span class="n">realized_weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;PTE foo&#39;</span><span class="p">,</span> <span class="s1">&#39;PTE bar&#39;</span><span class="p">]]</span>
<span class="n">realized_weights_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Target Weights vs PTE Weights&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_9_0.png"><img alt="_images/PTE_9_0.png" class="pynb" src="_images/PTE_9_0.png" style="width: 373px; height: 277px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trans_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">res_target</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span><span class="s1">&#39;PTE&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">transactions</span> <span class="o">=</span> <span class="n">res_target</span><span class="o">.</span><span class="n">get_transactions</span><span class="p">()</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">bar_mask</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Security&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span>
<span class="n">foo_mask</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Security&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>

<span class="n">trans_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trans_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span><span class="s1">&#39;Target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">bar_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">foo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span> <span class="o">=</span> <span class="n">res_PTE</span><span class="o">.</span><span class="n">get_transactions</span><span class="p">()</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">bar_mask</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Security&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span>
<span class="n">foo_mask</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Security&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>

<span class="n">trans_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="p">[</span><span class="n">bar_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;PTE&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">bar_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">trans_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="p">[</span><span class="n">foo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;PTE&#39;</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">foo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trans_df</span> <span class="o">=</span> <span class="n">trans_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">trans_df</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative sum of notional traded&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_13_0.png"><img alt="_images/PTE_13_0.png" class="pynb" src="_images/PTE_13_0.png" style="width: 373px; height: 277px;" /></a>
<p>If we plot the total risk contribution of each asset class and divide by
the total volatility, then we can see that both strategy’s contribute
roughly similar amounts of volatility from both of the securities.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights_target</span> <span class="o">=</span> <span class="n">res_target</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span>
<span class="n">rolling_cov_target</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span>

<span class="n">weights_PTE</span> <span class="o">=</span> <span class="n">res_PTE</span><span class="o">.</span><span class="n">get_security_weights</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">rolling_cov_PTE</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span>


<span class="n">trc_target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">columns</span>
<span class="p">)</span>

<span class="n">trc_PTE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">weights_PTE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; PTE&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">weights_PTE</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">trc_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="p">(</span><span class="n">rolling_cov_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@rolling_cov_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">trc_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">weights_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="p">(</span><span class="n">rolling_cov_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@rolling_cov_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="nd">@weights_PTE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,:]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">trc_target</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">trc_PTE</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Risk Contribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_15_0.png"><img alt="_images/PTE_15_0.png" class="pynb" src="_images/PTE_15_0.png" style="width: 386px; height: 277px;" /></a>
<p>Looking at the Target strategy’s and PTE strategy’s Total Risk they are
very similar.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">trc_target</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">)</span>
<span class="n">trc_PTE</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;PTE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Risk&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_17_0.png"><img alt="_images/PTE_17_0.png" class="pynb" src="_images/PTE_17_0.png" style="width: 380px; height: 277px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span> <span class="o">=</span> <span class="n">res_PTE</span><span class="o">.</span><span class="n">get_transactions</span><span class="p">()</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">bar_mask</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Security&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span>
<span class="n">dates_of_PTE_transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">[</span><span class="n">bar_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dates_of_PTE_transactions</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>    <span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>
 <span class="mi">2</span>    <span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>
 <span class="mi">4</span>    <span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>
 <span class="mi">6</span>    <span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>
 <span class="mi">8</span>    <span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>
 <span class="mi">10</span>   <span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span>
 <span class="mi">12</span>   <span class="mi">2015</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">07</span>
 <span class="mi">14</span>   <span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span>
 <span class="mi">16</span>   <span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span>
 <span class="mi">18</span>   <span class="mi">2017</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">23</span>
 <span class="mi">20</span>   <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">24</span>
 <span class="n">Name</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">datetime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">trc_target</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">trc_PTE</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="c1">#.abs().sum(axis=1).plot()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Risk&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">trc_target</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">trc_target</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">trc_PTE</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PTE&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates_of_PTE_transactions</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;PTE Transaction&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/PTE_19_0.png"><img alt="_images/PTE_19_0.png" class="pynb" src="_images/PTE_19_0.png" style="width: 397px; height: 266px;" /></a>
<p>We can see the Predicted Tracking Error of the PTE Strategy with each
transaction marked.</p>
</div>
</div>
<div class="section" id="fixed-income-examples">
<h2>Fixed Income Examples<a class="headerlink" href="#fixed-income-examples" title="Permalink to this heading">¶</a></h2>
<p>This example notebook illustrates some of the more sophisticated
functionality of the package, especially related to fixed income
securities and strategies. For fixed income strategies:</p>
<ul class="simple">
<li><p>capital allocations are not necessary, and initial capital is not
used</p></li>
<li><p>bankruptcy is disabled (as money can always be borrowed at some rate,
potentially represented as another asset)</p></li>
<li><p>weights are based off notional_value rather than value. For fixed
income securities, notional value is just the position. For non-fixed
income securities (i.e. equities), it is the market value of the
position.</p></li>
<li><p>strategy notional_value is always positive, equal to the sum of the
magnitudes of the notional values of all its children</p></li>
<li><p>strategy price is computed from additive PNL returns per unit of
notional_value, with a reference price of PAR</p></li>
<li><p>“rebalancing” the portfolio adjusts notionals rather than capital
allocations based on weights</p></li>
</ul>
<p>Further to the above characteristics of fixed income strategies, we also
demonstrate the usage of the following features which arise in these
types of use case:</p>
<ul class="simple">
<li><p>Coupon paying securities (i.e. bonds)</p></li>
<li><p>Handing of security lifecycle such as new issues and maturity</p></li>
<li><p>Usage of “On-The-Run” instruments, and rolling of positions into the
“new” on-the-run security at pre-defined times</p></li>
<li><p>Risk tracking/aggregation and hedging from pre-computed risk per unit
notional</p></li>
</ul>
<p>The notebook contains the following parts:</p>
<ol class="arabic simple" start="0">
<li><p><strong>Setup</strong></p></li>
<li><p><strong>Market data generation</strong></p>
<ol class="arabic simple">
<li><p>Rolling series of government bonds</p></li>
<li><p>Corporate bonds with spreads driven by a common factor</p></li>
</ol>
</li>
<li><p><strong>Example 1: Basic Strategies</strong></p>
<ol class="arabic simple">
<li><p>Weigh all active corporate bond equally</p></li>
<li><p>Add hedging of interest rates risk with the on-the-run government
bond</p></li>
</ol>
</li>
<li><p><strong>Example 2: Nested Strategies</strong></p>
<ol class="arabic simple">
<li><p>One strategy buys the top N bonds, by yield</p></li>
<li><p>Another strategy sells the bottom N bonds, by yield</p></li>
<li><p>Parent strategy gives 50% weight to each of the above</p></li>
<li><p>Add hedges of remaining interest rates risk with the on-the-run
government bond</p></li>
</ol>
</li>
</ol>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.frequencies</span> <span class="kn">import</span> <span class="n">to_offset</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># (Approximate) Price to yield calcs, and pvbp, for later use. Note we use clean price here.</span>
<span class="k">def</span> <span class="nf">price_to_yield</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">coupon</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span> <span class="n">coupon</span> <span class="o">+</span> <span class="p">(</span><span class="mf">100.</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">ttm</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span> <span class="mf">100.</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="k">def</span> <span class="nf">yield_to_price</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">coupon</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">coupon</span> <span class="o">+</span> <span class="mi">100</span><span class="o">/</span><span class="n">ttm</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">y</span><span class="o">/</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">ttm</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pvbp</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">coupon</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">yield_to_price</span><span class="p">(</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">coupon</span> <span class="p">)</span> <span class="o">-</span> <span class="n">yield_to_price</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">coupon</span> <span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Utility function to set data frame values to nan before the security has been issued or after it has matured</span>
<span class="k">def</span> <span class="nf">censor</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">ref_data</span> <span class="p">):</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ref_data</span><span class="p">[</span><span class="s1">&#39;mat_date&#39;</span><span class="p">][</span><span class="n">bond</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">ref_data</span><span class="p">[</span><span class="s1">&#39;issue_date&#39;</span><span class="p">][</span><span class="n">bond</span><span class="p">]),</span> <span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Because bonds might mature during a gap in the index (i.e. on the weekend)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting timeline setup</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-01-01&#39;</span><span class="p">)</span>
<span class="n">timeline</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="market-data-generation">
<h3>Market Data Generation<a class="headerlink" href="#market-data-generation" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Government Bonds: Create synthetic data for a single series of rolling government bonds</span>

<span class="c1"># Reference Data</span>
<span class="n">roll_freq</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
<span class="n">maturity</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">coupon</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">roll_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">+</span><span class="n">to_offset</span><span class="p">(</span><span class="n">roll_freq</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="n">roll_freq</span><span class="p">)</span> <span class="c1"># Go one period beyond the end date to be safe</span>
<span class="n">issue_dates</span> <span class="o">=</span> <span class="n">roll_dates</span> <span class="o">-</span> <span class="n">roll_dates</span><span class="o">.</span><span class="n">freq</span>
<span class="n">mat_dates</span> <span class="o">=</span> <span class="n">issue_dates</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">maturity</span><span class="p">)</span>
<span class="n">series_name</span> <span class="o">=</span> <span class="s1">&#39;govt_10Y&#39;</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mat_dates</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="s1">&#39;govt_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m&#39;</span><span class="p">))</span>
<span class="c1"># Build a time series of OTR</span>
<span class="n">govt_otr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">[</span> <span class="p">[</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">roll_date</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">roll_dates</span><span class="p">)</span> <span class="k">if</span> <span class="n">roll_date</span> <span class="o">&gt;=</span><span class="n">d</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">timeline</span> <span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">timeline</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">series_name</span><span class="p">])</span>
<span class="c1"># Create a data frame of reference data</span>
<span class="n">govt_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;mat_date&#39;</span><span class="p">:</span><span class="n">mat_dates</span><span class="p">,</span> <span class="s1">&#39;issue_date&#39;</span><span class="p">:</span> <span class="n">issue_dates</span><span class="p">,</span> <span class="s1">&#39;roll_date&#39;</span><span class="p">:</span><span class="n">roll_dates</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="n">names</span><span class="p">)</span>
<span class="n">govt_data</span><span class="p">[</span><span class="s1">&#39;coupon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coupon</span>

<span class="c1"># Create the &quot;roll map&quot;</span>
<span class="n">govt_roll_map</span> <span class="o">=</span> <span class="n">govt_otr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">govt_roll_map</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">govt_otr</span><span class="p">[</span><span class="n">series_name</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">govt_roll_map</span> <span class="o">=</span> <span class="n">govt_roll_map</span><span class="p">[</span> <span class="n">govt_roll_map</span><span class="p">[</span><span class="n">series_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">govt_roll_map</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span>
<span class="n">govt_roll_map</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">govt_roll_map</span> <span class="o">=</span> <span class="n">govt_roll_map</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">series_name</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Market Data and Risk</span>
<span class="n">govt_yield_initial</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">govt_yield_vol</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">govt_yield</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span> <span class="p">)</span>
<span class="n">govt_yield_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">govt_yield_initial</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">govt_yield_vol</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">))))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">govt_yield</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">govt_yield_ts</span>

<span class="n">govt_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64&#39;</span><span class="p">)</span>
<span class="n">govt_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">govt_data</span><span class="p">[</span><span class="s1">&#39;mat_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">govt_ttm</span> <span class="o">=</span> <span class="p">(</span><span class="n">govt_mat</span> <span class="o">-</span> <span class="n">timeline</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1Y&#39;</span><span class="p">)</span>
<span class="n">govt_coupon</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span> <span class="p">)</span>
<span class="n">govt_coupon</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">govt_data</span><span class="p">[</span><span class="s1">&#39;coupon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">govt_accrued</span> <span class="o">=</span> <span class="n">govt_coupon</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span> <span class="n">timeline</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1Y&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="n">govt_accrued</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">govt_price</span> <span class="o">=</span> <span class="n">yield_to_price</span><span class="p">(</span> <span class="n">govt_yield</span><span class="p">,</span> <span class="n">govt_ttm</span><span class="p">,</span> <span class="n">govt_coupon</span> <span class="p">)</span>
<span class="n">govt_price</span><span class="p">[</span> <span class="n">govt_ttm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">govt_price</span> <span class="o">=</span> <span class="n">censor</span><span class="p">(</span><span class="n">govt_price</span><span class="p">,</span> <span class="n">govt_data</span><span class="p">)</span>
<span class="n">govt_pvbp</span> <span class="o">=</span> <span class="n">pvbp</span><span class="p">(</span> <span class="n">govt_yield</span><span class="p">,</span> <span class="n">govt_ttm</span><span class="p">,</span> <span class="n">govt_coupon</span><span class="p">)</span>
<span class="n">govt_pvbp</span><span class="p">[</span> <span class="n">govt_ttm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">govt_pvbp</span> <span class="o">=</span> <span class="n">censor</span><span class="p">(</span><span class="n">govt_pvbp</span><span class="p">,</span> <span class="n">govt_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">interactiveshell</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3397</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">Units</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">and</span> <span class="s1">&#39;y&#39;</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">represent</span> <span class="n">unambiguous</span> <span class="n">timedelta</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span>
   <span class="n">exec</span><span class="p">(</span><span class="n">code_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Corporate Bonds: Create synthetic data for a universe of corporate bonds</span>

<span class="c1"># Reference Data</span>
<span class="n">n_corp</span> <span class="o">=</span> <span class="mi">50</span>    <span class="c1"># Number of corporate bonds to generate</span>
<span class="n">avg_ttm</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># Average time to maturity, in years</span>
<span class="n">coupon_mean</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">coupon_std</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">mat_dates</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">avg_ttm</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">n_corp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">()</span>
<span class="n">issue_dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">mat_dates</span><span class="p">,</span> <span class="n">end_date</span> <span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">avg_ttm</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">n_corp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span> <span class="p">[</span> <span class="s1">&#39;corp</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_corp</span><span class="p">)])</span>
<span class="n">coupons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">coupon_mean</span><span class="p">,</span> <span class="n">coupon_std</span><span class="p">,</span> <span class="n">n_corp</span> <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">corp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;mat_date&#39;</span><span class="p">:</span><span class="n">mat_dates</span><span class="p">,</span> <span class="s1">&#39;issue_date&#39;</span><span class="p">:</span> <span class="n">issue_dates</span><span class="p">,</span> <span class="s1">&#39;coupon&#39;</span><span class="p">:</span><span class="n">coupons</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

<span class="c1"># Market Data and Risk</span>
<span class="c1"># Model: corporate yield = government yield + credit spread</span>
<span class="c1"># Model: credit spread changes = beta * common factor changes + idiosyncratic changes</span>
<span class="n">corp_spread_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corp_data</span><span class="p">)</span> <span class="p">)</span>
<span class="n">corp_betas_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corp_data</span><span class="p">)</span> <span class="p">)</span>
<span class="n">corp_factor_vol</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">corp_idio_vol</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">corp_factor_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">corp_factor_vol</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">corp_idio_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">corp_idio_vol</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">corp_spread</span> <span class="o">=</span> <span class="n">corp_spread_initial</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span> <span class="n">corp_factor_ts</span><span class="p">,</span> <span class="n">corp_betas_raw</span> <span class="p">)</span> <span class="o">+</span> <span class="n">corp_idio_ts</span>
<span class="n">corp_yield</span> <span class="o">=</span> <span class="n">govt_yield_ts</span> <span class="o">+</span> <span class="n">corp_spread</span>
<span class="n">corp_yield</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  <span class="n">columns</span> <span class="o">=</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">corp_yield</span> <span class="p">)</span>

<span class="n">corp_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">start_date</span> <span class="p">)</span>
<span class="n">corp_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">corp_data</span><span class="p">[</span><span class="s1">&#39;mat_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">corp_ttm</span> <span class="o">=</span> <span class="p">(</span><span class="n">corp_mat</span> <span class="o">-</span> <span class="n">timeline</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1Y&#39;</span><span class="p">)</span>
<span class="n">corp_coupon</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span> <span class="p">)</span>
<span class="n">corp_coupon</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">corp_data</span><span class="p">[</span><span class="s1">&#39;coupon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">corp_accrued</span> <span class="o">=</span> <span class="n">corp_coupon</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span> <span class="n">timeline</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1Y&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="n">corp_accrued</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">corp_price</span> <span class="o">=</span> <span class="n">yield_to_price</span><span class="p">(</span> <span class="n">corp_yield</span><span class="p">,</span> <span class="n">corp_ttm</span><span class="p">,</span> <span class="n">corp_coupon</span> <span class="p">)</span>
<span class="n">corp_price</span><span class="p">[</span> <span class="n">corp_ttm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">corp_price</span> <span class="o">=</span> <span class="n">censor</span><span class="p">(</span><span class="n">corp_price</span><span class="p">,</span> <span class="n">corp_data</span><span class="p">)</span>

<span class="n">corp_pvbp</span> <span class="o">=</span> <span class="n">pvbp</span><span class="p">(</span> <span class="n">corp_yield</span><span class="p">,</span> <span class="n">corp_ttm</span><span class="p">,</span> <span class="n">corp_coupon</span><span class="p">)</span>
<span class="n">corp_pvbp</span><span class="p">[</span> <span class="n">corp_ttm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">corp_pvbp</span> <span class="o">=</span> <span class="n">censor</span><span class="p">(</span><span class="n">corp_pvbp</span><span class="p">,</span> <span class="n">corp_data</span><span class="p">)</span>

<span class="n">bidoffer_bps</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">corp_bidoffer</span> <span class="o">=</span> <span class="o">-</span><span class="n">bidoffer_bps</span> <span class="o">*</span> <span class="n">corp_pvbp</span>

<span class="n">corp_betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">timeline</span> <span class="p">)</span>
<span class="n">corp_betas</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">corp_betas_raw</span>
<span class="n">corp_betas</span> <span class="o">=</span> <span class="n">censor</span><span class="p">(</span><span class="n">corp_betas</span><span class="p">,</span> <span class="n">corp_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">interactiveshell</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3397</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">Units</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">and</span> <span class="s1">&#39;y&#39;</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">represent</span> <span class="n">unambiguous</span> <span class="n">timedelta</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span>
   <span class="n">exec</span><span class="p">(</span><span class="n">code_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="example-1-basic-strategies">
<h3>Example 1: Basic Strategies<a class="headerlink" href="#example-1-basic-strategies" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a strategy and a backtest</span>

<span class="c1"># The goal here is to define an equal weighted portfolio of corporate bonds,</span>
<span class="c1"># and to hedge the rates risk with the rolling series of government bonds</span>

<span class="c1"># Define Algo Stacks as the various building blocks</span>
<span class="c1"># Note that the order in which we execute these is extremely important</span>

<span class="n">lifecycle_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Close any matured bond positions (including hedges)</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ClosePositionsAfterDates</span><span class="p">(</span> <span class="s1">&#39;maturity&#39;</span> <span class="p">),</span>
    <span class="c1"># Roll government bond positions into the On The Run</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RollPositionsAfterDates</span><span class="p">(</span> <span class="s1">&#39;govt_roll_map&#39;</span> <span class="p">),</span>
<span class="p">)</span>
<span class="n">risk_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to calculate risk</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunWeekly</span><span class="p">(),</span>
                  <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">()]</span> <span class="p">),</span>
    <span class="c1"># Update the risk given any positions that have been put on so far in the current step</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;pvbp&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">hedging_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to hedge risk</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
    <span class="c1"># Select the &quot;alias&quot; for the on-the-run government bond...</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectThese</span><span class="p">(</span> <span class="p">[</span><span class="n">series_name</span><span class="p">],</span> <span class="n">include_no_data</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">),</span>
    <span class="c1"># ... and then resolve it to the underlying security for the given date</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ResolveOnTheRun</span><span class="p">(</span> <span class="s1">&#39;govt_otr&#39;</span> <span class="p">),</span>
    <span class="c1"># Hedge out the pvbp risk using the selected government bond</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">HedgeRisks</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">]),</span>
    <span class="c1"># Need to update risk again after hedging so that it gets recorded correctly (post-hedges)</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;pvbp&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">debug_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to display debug info</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s1">&#39;Strategy </span><span class="si">{name}</span><span class="s1"> : </span><span class="si">{now}</span><span class="s1">.</span><span class="se">\t</span><span class="s1">Notional:  </span><span class="si">{_notl_value:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Value: </span><span class="si">{_value:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Price: </span><span class="si">{_price:0.4f}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">PrintRisk</span><span class="p">(</span><span class="s1">&#39;Risk: </span><span class="se">\t</span><span class="s1">PVBP: </span><span class="si">{pvbp:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Beta: </span><span class="si">{beta:0.0f}</span><span class="s1">&#39;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">trading_stack</span> <span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
         <span class="c1"># Specify how frequently to rebalance the portfolio</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
         <span class="c1"># Select instruments for rebalancing. Start with everything</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
         <span class="c1"># Prevent matured/rolled instruments from coming back into the mix</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectActive</span><span class="p">(),</span>
         <span class="c1"># Select only corp instruments</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectRegex</span><span class="p">(</span> <span class="s1">&#39;corp&#39;</span> <span class="p">),</span>
         <span class="c1"># Specify how to weigh the securities</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
         <span class="c1"># Set the target portfolio size</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SetNotional</span><span class="p">(</span> <span class="s1">&#39;notional_value&#39;</span> <span class="p">),</span>
         <span class="c1"># Rebalance the portfolio</span>
         <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">govt_securities</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">CouponPayingHedgeSecurity</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">corp_securities</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">CouponPayingSecurity</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span>
<span class="n">securities</span> <span class="o">=</span> <span class="n">govt_securities</span> <span class="o">+</span> <span class="n">corp_securities</span>
<span class="n">base_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;BaseStrategy&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="n">lifecycle_stack</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">trading_stack</span><span class="p">,</span> <span class="n">risk_stack</span><span class="p">,</span> <span class="n">debug_stack</span> <span class="p">]</span> <span class="p">)</span> <span class="p">],</span> <span class="n">children</span> <span class="o">=</span> <span class="n">securities</span><span class="p">)</span>
<span class="n">hedged_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;HedgedStrategy&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="n">lifecycle_stack</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">trading_stack</span><span class="p">,</span> <span class="n">risk_stack</span><span class="p">,</span> <span class="n">hedging_stack</span><span class="p">,</span> <span class="n">debug_stack</span> <span class="p">]</span> <span class="p">)</span> <span class="p">],</span> <span class="n">children</span> <span class="o">=</span> <span class="n">securities</span><span class="p">)</span>

<span class="c1">#Collect all the data for the strategies</span>

<span class="c1"># Here we use clean prices as the data and accrued as the coupon. Could alternatively use dirty prices and cashflows.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span> <span class="n">govt_price</span><span class="p">,</span> <span class="n">corp_price</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>  <span class="c1"># Because we need prices per unit notional</span>
<span class="n">additional_data</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;coupons&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">govt_accrued</span><span class="p">,</span> <span class="n">corp_accrued</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span>
                   <span class="s1">&#39;bidoffer&#39;</span> <span class="p">:</span> <span class="n">corp_bidoffer</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>
                   <span class="s1">&#39;notional_value&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="p">),</span>
                   <span class="s1">&#39;maturity&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">govt_data</span><span class="p">,</span> <span class="n">corp_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mat_date&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">}),</span>
                   <span class="s1">&#39;govt_roll_map&#39;</span> <span class="p">:</span> <span class="n">govt_roll_map</span><span class="p">,</span>
                   <span class="s1">&#39;govt_otr&#39;</span> <span class="p">:</span> <span class="n">govt_otr</span><span class="p">,</span>
                   <span class="s1">&#39;unit_risk&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pvbp&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span> <span class="n">govt_pvbp</span><span class="p">,</span> <span class="n">corp_pvbp</span><span class="p">]</span> <span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>
                                  <span class="s1">&#39;beta&#39;</span> <span class="p">:</span> <span class="n">corp_betas</span> <span class="o">*</span> <span class="n">corp_pvbp</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">},</span>
                  <span class="p">}</span>
<span class="n">base_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span> <span class="n">base_strategy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;BaseBacktest&#39;</span><span class="p">,</span>
                <span class="n">initial_capital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">additional_data</span> <span class="o">=</span> <span class="n">additional_data</span> <span class="p">)</span>
<span class="n">hedge_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span> <span class="n">hedged_strategy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;HedgedBacktest&#39;</span><span class="p">,</span>
                <span class="n">initial_capital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">additional_data</span> <span class="o">=</span> <span class="n">additional_data</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span> <span class="n">base_test</span><span class="p">,</span> <span class="n">hedge_test</span> <span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">1644</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">99.8356</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">658</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">659</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">6454</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">99.3546</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">642</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">643</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">26488</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.3512</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">611</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">613</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">20295</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.9705</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">607</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">608</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">43692</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">95.6308</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">573</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">574</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">41095</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">95.8905</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">566</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">566</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">15724</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.4985</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">609</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">608</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">22308</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.8400</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">587</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">594</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">12832</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.4263</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">644</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">650</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">35263</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">103.6965</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">683</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">680</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">3702</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.5404</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">638</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">646</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">18534</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.3168</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">606</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">613</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">11054</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">99.0648</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">603</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">609</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">16424</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.5537</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">602</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">609</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">34462</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">96.6943</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">603</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">586</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">23533</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.7872</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">603</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">586</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">27024</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.4381</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">590</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">574</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">50723</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">95.0682</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">558</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">541</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">52714</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">94.8690</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">547</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">528</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">53039</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">94.8067</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">550</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">531</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">39027</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">96.2079</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">550</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">524</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">2051</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">99.9002</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">588</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">561</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">8616</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">99.2438</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">573</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">544</span>
 <span class="n">Strategy</span> <span class="n">BaseStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>        <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">53520</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">105.6538</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">656</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">623</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">1644</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">99.8356</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">659</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">10996</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.9004</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">643</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">16765</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.3235</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">613</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">21649</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.8351</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">608</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">33399</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">96.6601</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">574</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">22927</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">97.7073</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">566</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="o">-</span><span class="mi">14965</span><span class="p">,</span>  <span class="n">Price</span><span class="p">:</span> <span class="mf">98.5366</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">608</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">5092</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.5423</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">594</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">22278</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.2828</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">650</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">13903</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.4286</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">680</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">12081</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.2464</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">646</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">10531</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.0914</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">613</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">12144</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.2528</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">609</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">15903</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.6469</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">609</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">11958</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.2204</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">586</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">28170</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.8417</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">586</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">34561</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">103.4807</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">574</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">29233</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.9479</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">541</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">10323</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.0569</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">528</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">14539</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.4646</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">531</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">10754</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.0860</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">524</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">32502</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">103.2515</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">561</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">24506</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.4519</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">544</span>
 <span class="n">Strategy</span> <span class="n">HedgedStrategy</span> <span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.</span>      <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">42093</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">104.2905</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">623</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract Tear Sheet for base backtest</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;BaseBacktest&#39;</span><span class="p">]</span>
<span class="n">stats</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stats</span> <span class="k">for</span> <span class="n">BaseBacktest</span> <span class="kn">from</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
 <span class="n">Annual</span> <span class="n">risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span> <span class="n">considered</span><span class="p">:</span> <span class="mf">0.00</span><span class="o">%</span>
 <span class="n">Summary</span><span class="p">:</span>
 <span class="n">Total</span> <span class="n">Return</span>      <span class="n">Sharpe</span>  <span class="n">CAGR</span>    <span class="n">Max</span> <span class="n">Drawdown</span>
 <span class="o">--------------</span>  <span class="o">--------</span>  <span class="o">------</span>  <span class="o">--------------</span>
 <span class="mf">2.34</span><span class="o">%</span>               <span class="mf">0.19</span>  <span class="mf">1.16</span><span class="o">%</span>   <span class="o">-</span><span class="mf">10.64</span><span class="o">%</span>

 <span class="n">Annualized</span> <span class="n">Returns</span><span class="p">:</span>
 <span class="n">mtd</span>     <span class="mi">3</span><span class="n">m</span>     <span class="mi">6</span><span class="n">m</span>     <span class="n">ytd</span>    <span class="mi">1</span><span class="n">y</span>     <span class="mi">3</span><span class="n">y</span>     <span class="mi">5</span><span class="n">y</span>    <span class="mi">10</span><span class="n">y</span>    <span class="n">incep</span><span class="o">.</span>
 <span class="o">------</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">----</span>  <span class="o">-----</span>  <span class="o">--------</span>
 <span class="o">-</span><span class="mf">3.06</span><span class="o">%</span>  <span class="mf">1.45</span><span class="o">%</span>  <span class="mf">8.12</span><span class="o">%</span>  <span class="mf">3.43</span><span class="o">%</span>  <span class="mf">3.43</span><span class="o">%</span>  <span class="mf">1.16</span><span class="o">%</span>  <span class="o">-</span>     <span class="o">-</span>      <span class="mf">1.16</span><span class="o">%</span>

 <span class="n">Periodic</span><span class="p">:</span>
         <span class="n">daily</span>    <span class="n">monthly</span>    <span class="n">yearly</span>
 <span class="o">------</span>  <span class="o">-------</span>  <span class="o">---------</span>  <span class="o">--------</span>
 <span class="n">sharpe</span>  <span class="mf">0.19</span>     <span class="mf">0.18</span>       <span class="mf">0.38</span>
 <span class="n">mean</span>    <span class="mf">1.38</span><span class="o">%</span>    <span class="mf">1.49</span><span class="o">%</span>      <span class="mf">1.19</span><span class="o">%</span>
 <span class="n">vol</span>     <span class="mf">7.26</span><span class="o">%</span>    <span class="mf">8.35</span><span class="o">%</span>      <span class="mf">3.17</span><span class="o">%</span>
 <span class="n">skew</span>    <span class="mf">0.16</span>     <span class="mf">0.75</span>       <span class="o">-</span>
 <span class="n">kurt</span>    <span class="mf">0.52</span>     <span class="mf">0.70</span>       <span class="o">-</span>
 <span class="n">best</span>    <span class="mf">1.59</span><span class="o">%</span>    <span class="mf">6.32</span><span class="o">%</span>      <span class="mf">3.43</span><span class="o">%</span>
 <span class="n">worst</span>   <span class="o">-</span><span class="mf">1.44</span><span class="o">%</span>   <span class="o">-</span><span class="mf">3.29</span><span class="o">%</span>     <span class="o">-</span><span class="mf">1.05</span><span class="o">%</span>

 <span class="n">Drawdowns</span><span class="p">:</span>
 <span class="nb">max</span>      <span class="n">avg</span>       <span class="c1"># days</span>
 <span class="o">-------</span>  <span class="o">------</span>  <span class="o">--------</span>
 <span class="o">-</span><span class="mf">10.64</span><span class="o">%</span>  <span class="o">-</span><span class="mf">2.59</span><span class="o">%</span>     <span class="mf">79.22</span>

 <span class="n">Misc</span><span class="p">:</span>
 <span class="o">---------------</span>  <span class="o">------</span>
 <span class="n">avg</span><span class="o">.</span> <span class="n">up</span> <span class="n">month</span>    <span class="mf">1.88</span><span class="o">%</span>
 <span class="n">avg</span><span class="o">.</span> <span class="n">down</span> <span class="n">month</span>  <span class="o">-</span><span class="mf">1.63</span><span class="o">%</span>
 <span class="n">up</span> <span class="n">year</span> <span class="o">%</span>        <span class="mf">50.00</span><span class="o">%</span>
 <span class="mi">12</span><span class="n">m</span> <span class="n">up</span> <span class="o">%</span>         <span class="mf">57.14</span><span class="o">%</span>
 <span class="o">---------------</span>  <span class="o">------</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract Tear Sheet for hedged backtest</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;HedgedBacktest&#39;</span><span class="p">]</span>
<span class="n">stats</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stats</span> <span class="k">for</span> <span class="n">HedgedBacktest</span> <span class="kn">from</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
 <span class="n">Annual</span> <span class="n">risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span> <span class="n">considered</span><span class="p">:</span> <span class="mf">0.00</span><span class="o">%</span>
 <span class="n">Summary</span><span class="p">:</span>
 <span class="n">Total</span> <span class="n">Return</span>      <span class="n">Sharpe</span>  <span class="n">CAGR</span>    <span class="n">Max</span> <span class="n">Drawdown</span>
 <span class="o">--------------</span>  <span class="o">--------</span>  <span class="o">------</span>  <span class="o">--------------</span>
 <span class="mf">3.51</span><span class="o">%</span>               <span class="mf">0.41</span>  <span class="mf">1.74</span><span class="o">%</span>   <span class="o">-</span><span class="mf">3.87</span><span class="o">%</span>

 <span class="n">Annualized</span> <span class="n">Returns</span><span class="p">:</span>
 <span class="n">mtd</span>     <span class="mi">3</span><span class="n">m</span>      <span class="mi">6</span><span class="n">m</span>     <span class="n">ytd</span>    <span class="mi">1</span><span class="n">y</span>     <span class="mi">3</span><span class="n">y</span>     <span class="mi">5</span><span class="n">y</span>    <span class="mi">10</span><span class="n">y</span>    <span class="n">incep</span><span class="o">.</span>
 <span class="o">------</span>  <span class="o">------</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">-----</span>  <span class="o">----</span>  <span class="o">-----</span>  <span class="o">--------</span>
 <span class="o">-</span><span class="mf">0.47</span><span class="o">%</span>  <span class="o">-</span><span class="mf">0.30</span><span class="o">%</span>  <span class="mf">2.29</span><span class="o">%</span>  <span class="mf">2.46</span><span class="o">%</span>  <span class="mf">2.46</span><span class="o">%</span>  <span class="mf">1.74</span><span class="o">%</span>  <span class="o">-</span>     <span class="o">-</span>      <span class="mf">1.74</span><span class="o">%</span>

 <span class="n">Periodic</span><span class="p">:</span>
         <span class="n">daily</span>    <span class="n">monthly</span>    <span class="n">yearly</span>
 <span class="o">------</span>  <span class="o">-------</span>  <span class="o">---------</span>  <span class="o">--------</span>
 <span class="n">sharpe</span>  <span class="mf">0.41</span>     <span class="mf">0.43</span>       <span class="mf">1.71</span>
 <span class="n">mean</span>    <span class="mf">1.75</span><span class="o">%</span>    <span class="mf">1.81</span><span class="o">%</span>      <span class="mf">1.74</span><span class="o">%</span>
 <span class="n">vol</span>     <span class="mf">4.26</span><span class="o">%</span>    <span class="mf">4.22</span><span class="o">%</span>      <span class="mf">1.02</span><span class="o">%</span>
 <span class="n">skew</span>    <span class="o">-</span><span class="mf">0.17</span>    <span class="mf">0.67</span>       <span class="o">-</span>
 <span class="n">kurt</span>    <span class="mf">0.21</span>     <span class="o">-</span><span class="mf">0.46</span>      <span class="o">-</span>
 <span class="n">best</span>    <span class="mf">0.69</span><span class="o">%</span>    <span class="mf">2.82</span><span class="o">%</span>      <span class="mf">2.46</span><span class="o">%</span>
 <span class="n">worst</span>   <span class="o">-</span><span class="mf">1.07</span><span class="o">%</span>   <span class="o">-</span><span class="mf">1.62</span><span class="o">%</span>     <span class="mf">1.02</span><span class="o">%</span>

 <span class="n">Drawdowns</span><span class="p">:</span>
 <span class="nb">max</span>     <span class="n">avg</span>       <span class="c1"># days</span>
 <span class="o">------</span>  <span class="o">------</span>  <span class="o">--------</span>
 <span class="o">-</span><span class="mf">3.87</span><span class="o">%</span>  <span class="o">-</span><span class="mf">1.02</span><span class="o">%</span>     <span class="mf">49.57</span>

 <span class="n">Misc</span><span class="p">:</span>
 <span class="o">---------------</span>  <span class="o">-------</span>
 <span class="n">avg</span><span class="o">.</span> <span class="n">up</span> <span class="n">month</span>    <span class="mf">1.25</span><span class="o">%</span>
 <span class="n">avg</span><span class="o">.</span> <span class="n">down</span> <span class="n">month</span>  <span class="o">-</span><span class="mf">0.78</span><span class="o">%</span>
 <span class="n">up</span> <span class="n">year</span> <span class="o">%</span>        <span class="mf">100.00</span><span class="o">%</span>
 <span class="mi">12</span><span class="n">m</span> <span class="n">up</span> <span class="o">%</span>         <span class="mf">85.71</span><span class="o">%</span>
 <span class="o">---------------</span>  <span class="o">-------</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total PNL time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;hedged&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">values</span><span class="p">}</span> <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_13_0.png"><img alt="_images/Fixed_Income_13_0.png" class="pynb" src="_images/Fixed_Income_13_0.png" style="width: 395px; height: 262px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total risk time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base_pvbp&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">],</span>
               <span class="s1">&#39;hedged_pvbp&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">],</span>
               <span class="s1">&#39;beta&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]}</span> <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_14_0.png"><img alt="_images/Fixed_Income_14_0.png" class="pynb" src="_images/Fixed_Income_14_0.png" style="width: 383px; height: 248px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total bid/offer paid (same for both strategies)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base_pvbp&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">bidoffers_paid</span><span class="p">,</span>
               <span class="s1">&#39;hedged_pvbp&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">bidoffers_paid</span> <span class="p">})</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_15_0.png"><img alt="_images/Fixed_Income_15_0.png" class="pynb" src="_images/Fixed_Income_15_0.png" style="width: 383px; height: 262px;" /></a>
</div>
<div class="section" id="example-2-nested-strategies">
<h3>Example 2: Nested Strategies<a class="headerlink" href="#example-2-nested-strategies" title="Permalink to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a more complex strategy and a backtest</span>

<span class="c1"># The goal of the more complex strategy is to define two sub-strategies of corporate bonds</span>
<span class="c1"># - Highest yield bonds</span>
<span class="c1"># - Lowest yield bonds</span>
<span class="c1"># Then we will go long the high yield bonds, short the low yield bonds in equal weight</span>
<span class="c1"># Lastly we will hedge the rates risk with the government bond</span>

<span class="n">govt_securities</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">CouponPayingHedgeSecurity</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">corp_securities</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">CouponPayingSecurity</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">index</span> <span class="p">]</span>

<span class="k">def</span> <span class="nf">get_algos</span><span class="p">(</span> <span class="n">n</span><span class="p">,</span> <span class="n">sort_descending</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Helper function to return the algos for long or short portfolio, based on top n yields&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="c1"># Close any matured bond positions</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ClosePositionsAfterDates</span><span class="p">(</span> <span class="s1">&#39;corp_maturity&#39;</span> <span class="p">),</span>
        <span class="c1"># Specify how frequenty to rebalance</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
        <span class="c1"># Select instruments for rebalancing. Start with everything</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
        <span class="c1"># Prevent matured/rolled instruments from coming back into the mix</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectActive</span><span class="p">(),</span>
        <span class="c1"># Set the stat to be used for selection</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SetStat</span><span class="p">(</span> <span class="s1">&#39;corp_yield&#39;</span> <span class="p">),</span>
        <span class="c1"># Select the top N yielding bonds</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectN</span><span class="p">(</span> <span class="n">n</span><span class="p">,</span> <span class="n">sort_descending</span><span class="p">,</span> <span class="n">filter_selected</span><span class="o">=</span><span class="kc">True</span> <span class="p">),</span>
        <span class="c1"># Specify how to weigh the securities</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ScaleWeights</span><span class="p">(</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">sort_descending</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.</span><span class="p">),</span> <span class="c1"># Determine long/short</span>
        <span class="c1"># Set the target portfolio size</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SetNotional</span><span class="p">(</span> <span class="s1">&#39;notional_value&#39;</span> <span class="p">),</span>
        <span class="c1"># Rebalance the portfolio</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="n">bottom_algos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">top_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;TopStrategy&#39;</span><span class="p">,</span> <span class="n">get_algos</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">True</span> <span class="p">),</span> <span class="n">children</span> <span class="o">=</span> <span class="n">corp_securities</span><span class="p">)</span>
<span class="n">bottom_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;BottomStrategy&#39;</span><span class="p">,</span><span class="n">get_algos</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">False</span> <span class="p">),</span> <span class="n">children</span> <span class="o">=</span> <span class="n">corp_securities</span><span class="p">)</span>

<span class="n">risk_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to calculate risk</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunWeekly</span><span class="p">(),</span>
                  <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">()]</span> <span class="p">),</span>
    <span class="c1"># Update the risk given any positions that have been put on so far in the current step</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;pvbp&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">hedging_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Close any matured hedge positions (including hedges)</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ClosePositionsAfterDates</span><span class="p">(</span> <span class="s1">&#39;govt_maturity&#39;</span> <span class="p">),</span>
    <span class="c1"># Roll government bond positions into the On The Run</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RollPositionsAfterDates</span><span class="p">(</span> <span class="s1">&#39;govt_roll_map&#39;</span> <span class="p">),</span>
    <span class="c1"># Specify how frequently to hedge risk</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
    <span class="c1"># Select the &quot;alias&quot; for the on-the-run government bond...</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectThese</span><span class="p">(</span> <span class="p">[</span><span class="n">series_name</span><span class="p">],</span> <span class="n">include_no_data</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">),</span>
    <span class="c1"># ... and then resolve it to the underlying security for the given date</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">ResolveOnTheRun</span><span class="p">(</span> <span class="s1">&#39;govt_otr&#39;</span> <span class="p">),</span>
    <span class="c1"># Hedge out the pvbp risk using the selected government bond</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">HedgeRisks</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">]),</span>
    <span class="c1"># Need to update risk again after hedging so that it gets recorded correctly (post-hedges)</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">UpdateRisk</span><span class="p">(</span> <span class="s1">&#39;pvbp&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">debug_stack</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to display debug info</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunMonthly</span><span class="p">(),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{now}</span><span class="s1">: End   </span><span class="si">{name}</span><span class="se">\t</span><span class="s1">Notional:  </span><span class="si">{_notl_value:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Value: </span><span class="si">{_value:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Price: </span><span class="si">{_price:0.4f}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">PrintRisk</span><span class="p">(</span><span class="s1">&#39;Risk: </span><span class="se">\t</span><span class="s1">PVBP: </span><span class="si">{pvbp:0.0f}</span><span class="s1">,</span><span class="se">\t</span><span class="s1"> Beta: </span><span class="si">{beta:0.0f}</span><span class="s1">&#39;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">trading_stack</span> <span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AlgoStack</span><span class="p">(</span>
    <span class="c1"># Specify how frequently to rebalance the portfolio of sub-strategies</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunOnce</span><span class="p">(),</span>
    <span class="c1"># Specify how to weigh the sub-strategies</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighSpecified</span><span class="p">(</span> <span class="n">TopStrategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">BottomStrategy</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="c1"># Rebalance the portfolio</span>
    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">children</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_strategy</span><span class="p">,</span> <span class="n">bottom_strategy</span> <span class="p">]</span> <span class="o">+</span> <span class="n">govt_securities</span>
<span class="n">base_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;BaseStrategy&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">trading_stack</span><span class="p">,</span> <span class="n">risk_stack</span><span class="p">,</span> <span class="n">debug_stack</span> <span class="p">]</span> <span class="p">)</span> <span class="p">],</span> <span class="n">children</span> <span class="o">=</span> <span class="n">children</span><span class="p">)</span>
<span class="n">hedged_strategy</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">FixedIncomeStrategy</span><span class="p">(</span><span class="s1">&#39;HedgedStrategy&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span> <span class="p">[</span><span class="n">trading_stack</span><span class="p">,</span> <span class="n">risk_stack</span><span class="p">,</span> <span class="n">hedging_stack</span><span class="p">,</span> <span class="n">debug_stack</span> <span class="p">]</span> <span class="p">)</span> <span class="p">],</span> <span class="n">children</span> <span class="o">=</span> <span class="n">children</span><span class="p">)</span>

<span class="c1"># Here we use clean prices as the data and accrued as the coupon. Could alternatively use dirty prices and cashflows.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span> <span class="n">govt_price</span><span class="p">,</span> <span class="n">corp_price</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>  <span class="c1"># Because we need prices per unit notional</span>
<span class="n">additional_data</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;coupons&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">govt_accrued</span><span class="p">,</span> <span class="n">corp_accrued</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="c1"># Because we need coupons per unit notional</span>
                   <span class="s1">&#39;notional_value&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="p">),</span>
                   <span class="s1">&#39;govt_maturity&#39;</span> <span class="p">:</span> <span class="n">govt_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mat_date&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">}),</span>
                   <span class="s1">&#39;corp_maturity&#39;</span> <span class="p">:</span> <span class="n">corp_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mat_date&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">}),</span>
                   <span class="s1">&#39;govt_roll_map&#39;</span> <span class="p">:</span> <span class="n">govt_roll_map</span><span class="p">,</span>
                   <span class="s1">&#39;govt_otr&#39;</span> <span class="p">:</span> <span class="n">govt_otr</span><span class="p">,</span>
                   <span class="s1">&#39;corp_yield&#39;</span> <span class="p">:</span> <span class="n">corp_yield</span><span class="p">,</span>
                   <span class="s1">&#39;unit_risk&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pvbp&#39;</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span> <span class="n">govt_pvbp</span><span class="p">,</span> <span class="n">corp_pvbp</span><span class="p">]</span> <span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>
                                  <span class="s1">&#39;beta&#39;</span> <span class="p">:</span> <span class="n">corp_betas</span> <span class="o">*</span> <span class="n">corp_pvbp</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">},</span>
                  <span class="p">}</span>
<span class="n">base_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span> <span class="n">base_strategy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;BaseBacktest&#39;</span><span class="p">,</span>
                <span class="n">initial_capital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">additional_data</span> <span class="o">=</span> <span class="n">additional_data</span><span class="p">)</span>
<span class="n">hedge_test</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span> <span class="n">hedged_strategy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;HedgedBacktest&#39;</span><span class="p">,</span>
                <span class="n">initial_capital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">additional_data</span> <span class="o">=</span> <span class="n">additional_data</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span> <span class="n">base_test</span><span class="p">,</span> <span class="n">hedge_test</span> <span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">0</span><span class="p">,</span>    <span class="n">Value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="n">Price</span><span class="p">:</span> <span class="mf">100.0000</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">0</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">3277</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.1639</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">41</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">7297</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.3649</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">9336</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.4668</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">13453</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.6727</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">28</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">15887</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7943</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">26</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1800000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">16024</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.8010</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">28</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">14785</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7391</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">152</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">124</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1800000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">30310</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.5550</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">263</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">204</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">35915</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.8430</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">109</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">53</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">37649</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.9297</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span>       <span class="n">Beta</span><span class="p">:</span> <span class="mi">36</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">39045</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.9995</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">13</span><span class="p">,</span>       <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">40569</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.0758</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span>       <span class="n">Beta</span><span class="p">:</span> <span class="mi">31</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">41228</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.1094</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span>       <span class="n">Beta</span><span class="p">:</span> <span class="mi">27</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">38916</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.9868</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">101</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">47</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">40755</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.0788</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">31</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">43290</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.2055</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">43</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">35947</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.8384</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">235</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">91</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">35671</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.8246</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">123</span><span class="p">,</span>      <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">129</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">37756</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.9288</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">29</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">38434</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.9627</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">43</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">37082</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.8966</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">73</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">19</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">39526</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">102.0187</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">53</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">BaseStrategy</span>     <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">29228</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.4826</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">125</span><span class="p">,</span>       <span class="n">Beta</span><span class="p">:</span> <span class="mi">97</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">0</span><span class="p">,</span>    <span class="n">Value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="n">Price</span><span class="p">:</span> <span class="mf">100.0000</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">0</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">3277</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.1639</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">41</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">6159</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.3079</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">9008</span><span class="p">,</span>    <span class="n">Price</span><span class="p">:</span> <span class="mf">100.4504</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">12274</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.6137</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">28</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">14189</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7094</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">26</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1800000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">15451</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7752</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">28</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">12494</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.6273</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">124</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1800000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">23384</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.1967</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">204</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">16414</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.8372</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">53</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">22887</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.1609</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">36</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">24681</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.2506</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">34</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">26080</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.3205</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="mi">31</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">26954</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.3647</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">27</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">25008</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.2611</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">47</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">27730</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.3972</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">31</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">30112</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.5163</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">43</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">22951</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.1582</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="o">-</span><span class="mi">0</span><span class="p">,</span>        <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">91</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">15553</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7884</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">129</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">18657</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.9436</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">29</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">19441</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.9827</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="o">-</span><span class="mi">43</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">17903</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.9072</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">19</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">2000000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">20524</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">101.0383</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">53</span>
 <span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">End</span>   <span class="n">HedgedStrategy</span>   <span class="n">Notional</span><span class="p">:</span>  <span class="mi">1900000</span><span class="p">,</span>      <span class="n">Value</span><span class="p">:</span> <span class="mi">14170</span><span class="p">,</span>   <span class="n">Price</span><span class="p">:</span> <span class="mf">100.7071</span>
 <span class="n">Risk</span><span class="p">:</span>       <span class="n">PVBP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="n">Beta</span><span class="p">:</span> <span class="mi">97</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total PNL time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
               <span class="s1">&#39;hedged&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
               <span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;TopStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
               <span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;BottomStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_18_0.png"><img alt="_images/Fixed_Income_18_0.png" class="pynb" src="_images/Fixed_Income_18_0.png" style="width: 395px; height: 266px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total pvbp time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">],</span>
               <span class="s1">&#39;hedged&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">],</span>
               <span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;TopStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">],</span>
               <span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;BottomStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;pvbp&#39;</span><span class="p">]}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_19_0.png"><img alt="_images/Fixed_Income_19_0.png" class="pynb" src="_images/Fixed_Income_19_0.png" style="width: 383px; height: 248px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total beta time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
               <span class="s1">&#39;hedged&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
               <span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;TopStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
               <span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;BottomStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">risks</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_20_0.png"><img alt="_images/Fixed_Income_20_0.png" class="pynb" src="_images/Fixed_Income_20_0.png" style="width: 383px; height: 248px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># &quot;Price&quot; time series values</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
               <span class="s1">&#39;hedged&#39;</span><span class="p">:</span><span class="n">hedge_test</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
               <span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;TopStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
               <span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="n">base_test</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;BottomStrategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/Fixed_Income_21_0.png"><img alt="_images/Fixed_Income_21_0.png" class="pynb" src="_images/Fixed_Income_21_0.png" style="width: 377px; height: 262px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show transactions</span>
<span class="n">out</span><span class="o">.</span><span class="n">get_transactions</span><span class="p">(</span><span class="s1">&#39;HedgedBacktest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div class="pynb-result">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>price</th>
      <th>quantity</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Security</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="20" valign="top">2020-01-01</th>
      <th>corp0000</th>
      <td>1.009697</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0001</th>
      <td>0.991417</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0002</th>
      <td>1.016553</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0005</th>
      <td>1.035779</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0009</th>
      <td>1.014195</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0015</th>
      <td>0.849097</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0017</th>
      <td>1.018107</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0018</th>
      <td>1.009549</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0019</th>
      <td>0.908531</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0023</th>
      <td>1.216847</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0024</th>
      <td>1.094375</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0025</th>
      <td>1.054762</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0030</th>
      <td>0.888091</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0032</th>
      <td>1.086487</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0035</th>
      <td>0.996676</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0036</th>
      <td>1.070212</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0037</th>
      <td>0.992530</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0044</th>
      <td>0.959150</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>corp0048</th>
      <td>0.987408</td>
      <td>-100000.0</td>
    </tr>
    <tr>
      <th>corp0049</th>
      <td>1.016879</td>
      <td>-100000.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
        <aside>

            
            <a href="index.html" id="logo" title=bt><img class="logo" src="_static/logo.png" width="150px" height="150px" title=bt /></a>
            
            
            <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html"> Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#what-is-bt">What is bt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#a-quick-example">A Quick Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#features">Features</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#roadmap">Roadmap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install.html"> Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="algos.html"> All About Algos</a></li>
<li class="toctree-l1"><a class="reference internal" href="tree.html"> The Tree Structure</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#"> Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sma-strategy">SMA Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sma-crossover-strategy">SMA Crossover Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exploring-the-tree-structure">Exploring the Tree Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#buy-and-hold-strategy">Buy and Hold Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trend-example-1">Trend Example 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trend-example-2">Trend Example 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#strategy-combination">Strategy Combination</a></li>
<li class="toctree-l2"><a class="reference internal" href="#equally-weighted-risk-contributions-portfolio">Equally Weighted Risk Contributions Portfolio</a></li>
<li class="toctree-l2"><a class="reference internal" href="#predicted-tracking-error-rebalance-portfolio">Predicted Tracking Error Rebalance Portfolio</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixed-income-examples">Fixed Income Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bt.html"> API</a></li>
</ul>


            
            <ul>
                <li><a href="https://github.com/pmorissette/bt">Github</a></li>
            </ul>
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </aside>
    
      <div class="clearer"></div>
    </div>
        <div class="footer">
            bt was created by Philippe Morissette.
If you find a bug, please <a href="https://github.com/pmorissette/bt/issues/new" title="Open a new issue on Github">submit an issue</a> on Github.

        </div>

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-52308448-3', 'auto');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
        
  </body>
</html>