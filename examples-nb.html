
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMA Strategy &#8212; bt 0.2.10 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/klink.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
         
        <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
        
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono:400,500,700' rel='stylesheet' type='text/css'>
    
  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="sma-strategy">
<h1>SMA Strategy<a class="headerlink" href="#sma-strategy" title="Permalink to this heading">¶</a></h1>
<p>Let’s start off with a Simple Moving Average (SMA) strategy. We will
start with a simple version of the strategy, namely:</p>
<ul class="simple">
<li><p><strong>Select</strong> the securities that are currently above their 50 day
moving average</p></li>
<li><p><strong>Weigh</strong> each selected security equally</p></li>
<li><p><strong>Rebalance</strong> the portfolio to reflect the target weights</p></li>
</ul>
<p>This should be pretty simple to build. The only thing missing above is
the calculation of the simple moving average. When should this take
place?</p>
<p>Given the flexibility of <strong>bt</strong>, there is no strict rule. The average
calculation could be performed in an Algo, but that would be pretty
inefficient. A better way would be to calculate the moving average at
the beginning - before starting the backtest. After all, all the data is
known in advance.</p>
<p>Now that we know what we have to do, let’s get started. First we will
download some data and calculate the simple moving average.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aapl,msft,c,gs,ge&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>

<span class="c1"># calculate moving average DataFrame using pandas&#39; rolling_mean</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># a rolling mean is a moving average, right?</span>
<span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>It’s always a good idea to plot your data to make sure it looks ok. So
let’s see how the data + sma plot looks like.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s see what the data looks like - this is by no means a pretty chart, but it does the job</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sma</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_6_0.png"><img alt="_images/examples-nb_6_0.png" class="pynb" src="_images/examples-nb_6_0.png" style="width: 879px; height: 305px;" /></a>
<p>Looks legit.</p>
<p>Now that we have our data, we will need to create our security selection
logic. Let’s create a basic Algo that will select the securities that
are above their moving average.</p>
<p>Before we do that, let’s think about how we will code it. We could pass
the SMA data and then extract the row (from the sma DataFrame) on the
current date, compare the values to the current prices, and then keep a
list of those securities where the price is above the SMA. This is the
most straightforward approach. However, this is not very re-usable
because the logic within the Algo will be quite specific to the task at
hand and if we wish to change the logic, we will have to write a new
algo.</p>
<p>For example, what if we wanted to select securities that were below
their sma? Or what if we only wanted securities that were 5% above their
sma?</p>
<p>What we could do instead is pre-calculate the selection logic DataFrame
(a fast, vectorized operation) and write a generic Algo that takes in
this boolean DataFrame and returns the securities where the value is
True on a given date. This will be must faster and much more reusable.
Let’s see how the implementation looks like.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SelectWhere</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Selects securities based on an indicator DataFrame.</span>

<span class="sd">    Selects securities where the value is True on the current date (target.now).</span>

<span class="sd">    Args:</span>
<span class="sd">        * signal (DataFrame): DataFrame containing the signal (boolean DataFrame)</span>

<span class="sd">    Sets:</span>
<span class="sd">        * selected</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># get signal on target.now</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">now</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">now</span><span class="p">]</span>

            <span class="c1"># get indices where true as list</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>

            <span class="c1"># save in temp - this will be used by the weighing algo</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span>

        <span class="c1"># return True because we want to keep on moving down the stack</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>So there we have it. Our selection Algo.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By the way, this Algo already exists - I just wanted to show you how you would code it from scratch.
<a class="reference internal" href="bt.html#bt.algos.SelectWhere" title="bt.algos.SelectWhere"><code class="xref py py-class docutils literal notranslate"><span class="pre">Here</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">code</span></code></a>.</p>
</div>
<p>All we have to do now is pass in a signal matrix. In our case, it’s quite easy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">signal</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span>
</pre></div>
</div>
<p>Simple, concise and more importantly, fast! Let’s move on and test the strategy.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first we create the Strategy</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;above50sma&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="p">),</span>
                               <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                               <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="c1"># now we create the Backtest</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># and let&#39;s run it!</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>So just to recap, we created the strategy, created the backtest by joining Strategy+Data, and ran the backtest. Let’s see the results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># what does the equity curve look like?</span>
<span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_12_0.png"><img alt="_images/examples-nb_12_0.png" class="pynb" src="_images/examples-nb_12_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and some performance stats</span>
<span class="n">res</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stat</span>                 <span class="n">above50sma</span>
 <span class="o">-------------------</span>  <span class="o">------------</span>
 <span class="n">Start</span>                <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>
 <span class="n">End</span>                  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>
 <span class="n">Risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span>       <span class="mf">0.00</span><span class="o">%</span>

 <span class="n">Total</span> <span class="n">Return</span>         <span class="mf">116.08</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.42</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.63</span>
 <span class="n">CAGR</span>                 <span class="mf">6.36</span><span class="o">%</span>
 <span class="n">Max</span> <span class="n">Drawdown</span>         <span class="o">-</span><span class="mf">39.43</span><span class="o">%</span>
 <span class="n">Calmar</span> <span class="n">Ratio</span>         <span class="mf">0.16</span>

 <span class="n">MTD</span>                  <span class="mf">0.00</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">19.50</span><span class="o">%</span>
 <span class="mi">6</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">26.03</span><span class="o">%</span>
 <span class="n">YTD</span>                  <span class="o">-</span><span class="mf">26.03</span><span class="o">%</span>
 <span class="mi">1</span><span class="n">Y</span>                   <span class="o">-</span><span class="mf">22.10</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">10.34</span><span class="o">%</span>
 <span class="mi">5</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">1.89</span><span class="o">%</span>
 <span class="mi">10</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>           <span class="mf">8.70</span><span class="o">%</span>
 <span class="n">Since</span> <span class="n">Incep</span><span class="o">.</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">6.36</span><span class="o">%</span>

 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.42</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.63</span>
 <span class="n">Daily</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>    <span class="mf">8.07</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>     <span class="mf">19.45</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Skew</span>           <span class="o">-</span><span class="mf">0.65</span>
 <span class="n">Daily</span> <span class="n">Kurt</span>           <span class="mf">4.74</span>
 <span class="n">Best</span> <span class="n">Day</span>             <span class="mf">5.78</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Day</span>            <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>

 <span class="n">Monthly</span> <span class="n">Sharpe</span>       <span class="mf">0.39</span>
 <span class="n">Monthly</span> <span class="n">Sortino</span>      <span class="mf">0.65</span>
 <span class="n">Monthly</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">8.59</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>   <span class="mf">21.86</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Skew</span>         <span class="o">-</span><span class="mf">0.37</span>
 <span class="n">Monthly</span> <span class="n">Kurt</span>         <span class="mf">0.73</span>
 <span class="n">Best</span> <span class="n">Month</span>           <span class="mf">21.65</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Month</span>          <span class="o">-</span><span class="mf">17.26</span><span class="o">%</span>

 <span class="n">Yearly</span> <span class="n">Sharpe</span>        <span class="mf">0.41</span>
 <span class="n">Yearly</span> <span class="n">Sortino</span>       <span class="mf">0.83</span>
 <span class="n">Yearly</span> <span class="n">Mean</span>          <span class="mf">9.78</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Vol</span>           <span class="mf">23.65</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Skew</span>          <span class="o">-</span><span class="mf">0.88</span>
 <span class="n">Yearly</span> <span class="n">Kurt</span>          <span class="o">-</span><span class="mf">0.67</span>
 <span class="n">Best</span> <span class="n">Year</span>            <span class="mf">34.85</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Year</span>           <span class="o">-</span><span class="mf">34.38</span><span class="o">%</span>

 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span>        <span class="o">-</span><span class="mf">3.56</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span> <span class="n">Days</span>   <span class="mf">47.27</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Up</span> <span class="n">Month</span>        <span class="mf">4.76</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Down</span> <span class="n">Month</span>      <span class="o">-</span><span class="mf">5.35</span><span class="o">%</span>
 <span class="n">Win</span> <span class="n">Year</span> <span class="o">%</span>           <span class="mf">66.67</span><span class="o">%</span>
 <span class="n">Win</span> <span class="mi">12</span><span class="n">m</span> <span class="o">%</span>            <span class="mf">67.14</span><span class="o">%</span>
</pre></div>
</div>
<p>Nothing stellar but at least you learnt something along the way (I
hope).</p>
<p>Oh, and one more thing. If you were to write your own “library” of
backtests, you might want to write yourself a helper function that would
allow you to test different parameters and securities. That function
might look something like this:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;above_sma&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Long securities that are above their n period</span>
<span class="sd">    Simple Moving Averages with equal weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># download data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="c1"># calc sma</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">sma_per</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># create strategy</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">SelectWhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="p">),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

    <span class="c1"># now we create the backtest</span>
    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>This function allows us to easily generate backtests. We could easily
compare a few different SMA periods. Also, let’s see if we can beat a
long-only allocation to the SPY.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple backtest to test long-only allocation</span>
<span class="k">def</span> <span class="nf">long_only_ew</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;long_only_ew&#39;</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">RunOnce</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighEqually</span><span class="p">(),</span>
                           <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># create the backtests</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;aapl,msft,c,gs,ge&#39;</span>
<span class="n">sma10</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma10&#39;</span><span class="p">)</span>
<span class="n">sma20</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma20&#39;</span><span class="p">)</span>
<span class="n">sma40</span> <span class="o">=</span> <span class="n">above_sma</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sma_per</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sma40&#39;</span><span class="p">)</span>
<span class="n">benchmark</span> <span class="o">=</span> <span class="n">long_only_ew</span><span class="p">(</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">)</span>

<span class="c1"># run all the backtests!</span>
<span class="n">res2</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sma10</span><span class="p">,</span> <span class="n">sma20</span><span class="p">,</span> <span class="n">sma40</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">);</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_18_0.png"><img alt="_images/examples-nb_18_0.png" class="pynb" src="_images/examples-nb_18_0.png" style="width: 879px; height: 320px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<div class="pynb-result highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Stat</span>                 <span class="n">sma10</span>       <span class="n">sma20</span>       <span class="n">sma40</span>       <span class="n">spy</span>
 <span class="o">-------------------</span>  <span class="o">----------</span>  <span class="o">----------</span>  <span class="o">----------</span>  <span class="o">----------</span>
 <span class="n">Start</span>                <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>
 <span class="n">End</span>                  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>  <span class="mi">2022</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>
 <span class="n">Risk</span><span class="o">-</span><span class="n">free</span> <span class="n">rate</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>

 <span class="n">Total</span> <span class="n">Return</span>         <span class="mf">284.16</span><span class="o">%</span>     <span class="mf">229.80</span><span class="o">%</span>     <span class="mf">145.62</span><span class="o">%</span>     <span class="mf">321.22</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.63</span>        <span class="mf">0.58</span>        <span class="mf">0.47</span>        <span class="mf">0.75</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.99</span>        <span class="mf">0.91</span>        <span class="mf">0.73</span>        <span class="mf">1.15</span>
 <span class="n">CAGR</span>                 <span class="mf">11.38</span><span class="o">%</span>      <span class="mf">10.03</span><span class="o">%</span>      <span class="mf">7.46</span><span class="o">%</span>       <span class="mf">12.20</span><span class="o">%</span>
 <span class="n">Max</span> <span class="n">Drawdown</span>         <span class="o">-</span><span class="mf">31.77</span><span class="o">%</span>     <span class="o">-</span><span class="mf">40.72</span><span class="o">%</span>     <span class="o">-</span><span class="mf">34.93</span><span class="o">%</span>     <span class="o">-</span><span class="mf">33.72</span><span class="o">%</span>
 <span class="n">Calmar</span> <span class="n">Ratio</span>         <span class="mf">0.36</span>        <span class="mf">0.25</span>        <span class="mf">0.21</span>        <span class="mf">0.36</span>

 <span class="n">MTD</span>                  <span class="o">-</span><span class="mf">0.76</span><span class="o">%</span>      <span class="mf">0.00</span><span class="o">%</span>       <span class="mf">0.00</span><span class="o">%</span>       <span class="o">-</span><span class="mf">0.37</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">10.58</span><span class="o">%</span>     <span class="o">-</span><span class="mf">22.25</span><span class="o">%</span>     <span class="o">-</span><span class="mf">18.82</span><span class="o">%</span>     <span class="o">-</span><span class="mf">16.66</span><span class="o">%</span>
 <span class="mi">6</span><span class="n">m</span>                   <span class="o">-</span><span class="mf">10.71</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.14</span><span class="o">%</span>     <span class="o">-</span><span class="mf">30.31</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>
 <span class="n">YTD</span>                  <span class="o">-</span><span class="mf">10.71</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.14</span><span class="o">%</span>     <span class="o">-</span><span class="mf">30.31</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>
 <span class="mi">1</span><span class="n">Y</span>                   <span class="o">-</span><span class="mf">13.63</span><span class="o">%</span>     <span class="o">-</span><span class="mf">24.65</span><span class="o">%</span>     <span class="o">-</span><span class="mf">27.20</span><span class="o">%</span>     <span class="o">-</span><span class="mf">11.44</span><span class="o">%</span>
 <span class="mi">3</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">28.10</span><span class="o">%</span>      <span class="mf">14.77</span><span class="o">%</span>      <span class="mf">3.73</span><span class="o">%</span>       <span class="mf">10.10</span><span class="o">%</span>
 <span class="mi">5</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>            <span class="mf">15.80</span><span class="o">%</span>      <span class="mf">8.37</span><span class="o">%</span>       <span class="mf">1.96</span><span class="o">%</span>       <span class="mf">11.11</span><span class="o">%</span>
 <span class="mi">10</span><span class="n">Y</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>           <span class="mf">13.76</span><span class="o">%</span>      <span class="mf">10.96</span><span class="o">%</span>      <span class="mf">9.67</span><span class="o">%</span>       <span class="mf">12.78</span><span class="o">%</span>
 <span class="n">Since</span> <span class="n">Incep</span><span class="o">.</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">11.38</span><span class="o">%</span>      <span class="mf">10.03</span><span class="o">%</span>      <span class="mf">7.46</span><span class="o">%</span>       <span class="mf">12.20</span><span class="o">%</span>

 <span class="n">Daily</span> <span class="n">Sharpe</span>         <span class="mf">0.63</span>        <span class="mf">0.58</span>        <span class="mf">0.47</span>        <span class="mf">0.75</span>
 <span class="n">Daily</span> <span class="n">Sortino</span>        <span class="mf">0.99</span>        <span class="mf">0.91</span>        <span class="mf">0.73</span>        <span class="mf">1.15</span>
 <span class="n">Daily</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>    <span class="mf">12.88</span><span class="o">%</span>      <span class="mf">11.52</span><span class="o">%</span>      <span class="mf">9.01</span><span class="o">%</span>       <span class="mf">13.03</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>     <span class="mf">20.48</span><span class="o">%</span>      <span class="mf">19.79</span><span class="o">%</span>      <span class="mf">18.97</span><span class="o">%</span>      <span class="mf">17.34</span><span class="o">%</span>
 <span class="n">Daily</span> <span class="n">Skew</span>           <span class="o">-</span><span class="mf">0.11</span>       <span class="o">-</span><span class="mf">0.29</span>       <span class="o">-</span><span class="mf">0.45</span>       <span class="o">-</span><span class="mf">0.59</span>
 <span class="n">Daily</span> <span class="n">Kurt</span>           <span class="mf">6.61</span>        <span class="mf">6.23</span>        <span class="mf">4.32</span>        <span class="mf">11.75</span>
 <span class="n">Best</span> <span class="n">Day</span>             <span class="mf">10.47</span><span class="o">%</span>      <span class="mf">10.47</span><span class="o">%</span>      <span class="mf">6.20</span><span class="o">%</span>       <span class="mf">9.06</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Day</span>            <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">8.26</span><span class="o">%</span>      <span class="o">-</span><span class="mf">10.94</span><span class="o">%</span>

 <span class="n">Monthly</span> <span class="n">Sharpe</span>       <span class="mf">0.65</span>        <span class="mf">0.54</span>        <span class="mf">0.43</span>        <span class="mf">0.92</span>
 <span class="n">Monthly</span> <span class="n">Sortino</span>      <span class="mf">1.18</span>        <span class="mf">1.02</span>        <span class="mf">0.75</span>        <span class="mf">1.62</span>
 <span class="n">Monthly</span> <span class="n">Mean</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>  <span class="mf">13.56</span><span class="o">%</span>      <span class="mf">11.95</span><span class="o">%</span>      <span class="mf">9.71</span><span class="o">%</span>       <span class="mf">13.00</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Vol</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="p">)</span>   <span class="mf">20.96</span><span class="o">%</span>      <span class="mf">21.94</span><span class="o">%</span>      <span class="mf">22.42</span><span class="o">%</span>      <span class="mf">14.20</span><span class="o">%</span>
 <span class="n">Monthly</span> <span class="n">Skew</span>         <span class="o">-</span><span class="mf">0.02</span>       <span class="mf">0.22</span>        <span class="o">-</span><span class="mf">0.10</span>       <span class="o">-</span><span class="mf">0.40</span>
 <span class="n">Monthly</span> <span class="n">Kurt</span>         <span class="mf">1.01</span>        <span class="mf">1.11</span>        <span class="mf">0.67</span>        <span class="mf">0.89</span>
 <span class="n">Best</span> <span class="n">Month</span>           <span class="mf">22.75</span><span class="o">%</span>      <span class="mf">24.73</span><span class="o">%</span>      <span class="mf">21.97</span><span class="o">%</span>      <span class="mf">12.70</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Month</span>          <span class="o">-</span><span class="mf">16.94</span><span class="o">%</span>     <span class="o">-</span><span class="mf">14.34</span><span class="o">%</span>     <span class="o">-</span><span class="mf">15.86</span><span class="o">%</span>     <span class="o">-</span><span class="mf">12.49</span><span class="o">%</span>

 <span class="n">Yearly</span> <span class="n">Sharpe</span>        <span class="mf">0.54</span>        <span class="mf">0.43</span>        <span class="mf">0.40</span>        <span class="mf">0.80</span>
 <span class="n">Yearly</span> <span class="n">Sortino</span>       <span class="mf">2.01</span>        <span class="mf">1.03</span>        <span class="mf">0.77</span>        <span class="mf">2.15</span>
 <span class="n">Yearly</span> <span class="n">Mean</span>          <span class="mf">13.38</span><span class="o">%</span>      <span class="mf">13.94</span><span class="o">%</span>      <span class="mf">9.76</span><span class="o">%</span>       <span class="mf">12.67</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Vol</span>           <span class="mf">24.64</span><span class="o">%</span>      <span class="mf">32.80</span><span class="o">%</span>      <span class="mf">24.22</span><span class="o">%</span>      <span class="mf">15.79</span><span class="o">%</span>
 <span class="n">Yearly</span> <span class="n">Skew</span>          <span class="mf">0.41</span>        <span class="o">-</span><span class="mf">0.15</span>       <span class="o">-</span><span class="mf">0.87</span>       <span class="o">-</span><span class="mf">0.68</span>
 <span class="n">Yearly</span> <span class="n">Kurt</span>          <span class="o">-</span><span class="mf">0.43</span>       <span class="o">-</span><span class="mf">0.96</span>       <span class="o">-</span><span class="mf">0.59</span>       <span class="mf">0.12</span>
 <span class="n">Best</span> <span class="n">Year</span>            <span class="mf">62.47</span><span class="o">%</span>      <span class="mf">66.99</span><span class="o">%</span>      <span class="mf">39.35</span><span class="o">%</span>      <span class="mf">32.31</span><span class="o">%</span>
 <span class="n">Worst</span> <span class="n">Year</span>           <span class="o">-</span><span class="mf">18.59</span><span class="o">%</span>     <span class="o">-</span><span class="mf">37.01</span><span class="o">%</span>     <span class="o">-</span><span class="mf">32.06</span><span class="o">%</span>     <span class="o">-</span><span class="mf">20.28</span><span class="o">%</span>

 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span>        <span class="o">-</span><span class="mf">3.95</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.49</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.68</span><span class="o">%</span>      <span class="o">-</span><span class="mf">1.69</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Drawdown</span> <span class="n">Days</span>   <span class="mf">40.43</span>       <span class="mf">35.12</span>       <span class="mf">48.79</span>       <span class="mf">15.92</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Up</span> <span class="n">Month</span>        <span class="mf">4.68</span><span class="o">%</span>       <span class="mf">5.00</span><span class="o">%</span>       <span class="mf">4.69</span><span class="o">%</span>       <span class="mf">3.20</span><span class="o">%</span>
 <span class="n">Avg</span><span class="o">.</span> <span class="n">Down</span> <span class="n">Month</span>      <span class="o">-</span><span class="mf">5.00</span><span class="o">%</span>      <span class="o">-</span><span class="mf">4.85</span><span class="o">%</span>      <span class="o">-</span><span class="mf">5.70</span><span class="o">%</span>      <span class="o">-</span><span class="mf">3.56</span><span class="o">%</span>
 <span class="n">Win</span> <span class="n">Year</span> <span class="o">%</span>           <span class="mf">58.33</span><span class="o">%</span>      <span class="mf">66.67</span><span class="o">%</span>      <span class="mf">75.00</span><span class="o">%</span>      <span class="mf">83.33</span><span class="o">%</span>
 <span class="n">Win</span> <span class="mi">12</span><span class="n">m</span> <span class="o">%</span>            <span class="mf">68.57</span><span class="o">%</span>      <span class="mf">66.43</span><span class="o">%</span>      <span class="mf">69.29</span><span class="o">%</span>      <span class="mf">91.43</span><span class="o">%</span>
</pre></div>
</div>
<p>And there you have it. Beating the market ain’t that easy!</p>
</div>
<div class="section" id="sma-crossover-strategy">
<h1>SMA Crossover Strategy<a class="headerlink" href="#sma-crossover-strategy" title="Permalink to this heading">¶</a></h1>
<p>Let’s build on the last section to test a moving average crossover
strategy. The easiest way to achieve this is to build an Algo similar to
SelectWhere, but for the purpose of setting target weights. Let’s call
this algo WeighTarget. This algo will take a DataFrame of target weights
that we will pre-calculate.</p>
<p>Basically, when the 50 day moving average will be above the 200-day
moving average, we will be long (+1 target weight). Conversely, when the
50 is below the 200, we will be short (-1 target weight).</p>
<p>Here’s the WeighTarget implementation (this Algo also already exists in
the algos module):</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WeighTarget</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Algo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets target weights based on a target weight DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        * target_weights (DataFrame): DataFrame containing the target weights</span>

<span class="sd">    Sets:</span>
<span class="sd">        * weights</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw</span> <span class="o">=</span> <span class="n">target_weights</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># get target weights on date target.now</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">now</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">now</span><span class="p">]</span>

            <span class="c1"># save in temp - this will be used by the weighing algo</span>
            <span class="c1"># also dropping any na&#39;s just in case they pop up</span>
            <span class="n">target</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># return True because we want to keep on moving down the stack</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>So let’s start with a simple 50-200 day sma crossover for a single
security.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## download some data &amp; calc SMAs</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>
<span class="n">sma50</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sma200</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1">## now we need to calculate our target weight DataFrame</span>
<span class="c1"># first we will copy the sma200 DataFrame since our weights will have the same strucutre</span>
<span class="n">tw</span> <span class="o">=</span> <span class="n">sma200</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># set appropriate target weights</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma50</span> <span class="o">&gt;</span> <span class="n">sma200</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma50</span> <span class="o">&lt;=</span> <span class="n">sma200</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="c1"># here we will set the weight to 0 - this is because the sma200 needs 200 data points before</span>
<span class="c1"># calculating its first point. Therefore, it will start with a bunch of nulls (NaNs).</span>
<span class="n">tw</span><span class="p">[</span><span class="n">sma200</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>Ok so we downloaded our data, calculated the simple moving averages, and
then we setup our target weight (tw) DataFrame. Let’s take a look at our
target weights to see if they make any sense.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the target weights + chart of price &amp; SMAs</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sma50</span><span class="p">,</span> <span class="n">sma200</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tw&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sma50&#39;</span><span class="p">,</span> <span class="s1">&#39;sma200&#39;</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">secondary_y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tw&#39;</span><span class="p">])</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_26_0.png"><img alt="_images/examples-nb_26_0.png" class="pynb" src="_images/examples-nb_26_0.png" style="width: 916px; height: 305px;" /></a>
<p>As mentioned earlier, it’s always a good idea to plot your strategy
data. It is usually easier to spot logic/programming errors this way,
especially when dealing with lots of data.</p>
<p>Now let’s move on with the Strategy &amp; Backtest.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ma_cross</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;ma_cross&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">WeighTarget</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span>
                                    <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">ma_cross</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_29_0.png"><img alt="_images/examples-nb_29_0.png" class="pynb" src="_images/examples-nb_29_0.png" style="width: 879px; height: 304px;" /></a>
<p>Ok great so there we have our basic moving average crossover strategy.</p>
</div>
<div class="section" id="exploring-the-tree-structure">
<h1>Exploring the Tree Structure<a class="headerlink" href="#exploring-the-tree-structure" title="Permalink to this heading">¶</a></h1>
<p>So far, we have explored strategies that allocate capital to securities.
But what if we wanted to test a strategy that allocated capital to
sub-strategies?</p>
<p>The most straightforward way would be to test the different
sub-strategies, extract their equity curves and create “synthetic
securities” that would basically just represent the returns achieved
from allocating capital to the different sub-strategies.</p>
<p>Let’s see how this looks:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first let&#39;s create a helper function to create a ma cross backtest</span>
<span class="k">def</span> <span class="nf">ma_cross</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span>
             <span class="n">short_ma</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">long_ma</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ma_cross&#39;</span><span class="p">):</span>
    <span class="c1"># these are all the same steps as above</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="n">short_sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">short_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">long_sma</span>  <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">long_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># target weights</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">long_sma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">short_sma</span> <span class="o">&gt;</span> <span class="n">long_sma</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">short_sma</span> <span class="o">&lt;=</span> <span class="n">long_sma</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">tw</span><span class="p">[</span><span class="n">long_sma</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># here we specify the children (3rd) arguemnt to make sure the strategy</span>
    <span class="c1"># has the proper universe. This is necessary in strategies of strategies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">WeighTarget</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()],</span> <span class="p">[</span><span class="n">ticker</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># ok now let&#39;s create a few backtests and gather the results.</span>
<span class="c1"># these will later become our &quot;synthetic securities&quot;</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;aapl&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;msft&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">)</span>

<span class="c1"># let&#39;s run these strategies now</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

<span class="c1"># now that we have run the strategies, let&#39;s extract</span>
<span class="c1"># the data to create &quot;synthetic securities&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

<span class="c1"># now we have our new data. This data is basically the equity</span>
<span class="c1"># curves of both backtested strategies. Now we can just use this</span>
<span class="c1"># to test any old strategy, just like before.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()])</span>

<span class="c1"># create and run</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_32_0.png"><img alt="_images/examples-nb_32_0.png" class="pynb" src="_images/examples-nb_32_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_weights</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_33_0.png"><img alt="_images/examples-nb_33_0.png" class="pynb" src="_images/examples-nb_33_0.png" style="width: 876px; height: 289px;" /></a>
<p>As we can see above, the process is a bit more involved, but it works.
It is not very elegant though, and obtaining security-level allocation
information is problematic.</p>
<p>Luckily, bt has built-in functionality for dealing with strategies of
strategies. It uses the same general principal as demonstrated above but
does it seamlessly. Basically, when a strategy is a child of another
strategy, it will create a “paper trade” version of itself internally.
As we run our strategy, it will run its internal “paper version” and use
the returns from that strategy to populate the <strong>price</strong> property.</p>
<p>This means that the parent strategy can use the price information (which
reflects the returns of the strategy had it been employed) to determine
the appropriate allocation. Again, this is basically the same process as
above, just packed into 1 step.</p>
<p>Perhaps some code will help:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># once again, we will create a few backtests</span>
<span class="c1"># these will be the child strategies</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;aapl&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aapl_ma_cross&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">ma_cross</span><span class="p">(</span><span class="s1">&#39;msft&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;msft_ma_cross&#39;</span><span class="p">)</span>

<span class="c1"># let&#39;s extract the data object</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># now we create the parent strategy</span>
<span class="c1"># we specify the children to be the two</span>
<span class="c1"># strategies created above</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">SelectAll</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">WeighInvVol</span><span class="p">(),</span>
                      <span class="n">bt</span><span class="o">.</span><span class="n">algos</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">()],</span>
                <span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">strategy</span><span class="p">])</span>

<span class="c1"># create and run</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Backtest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_36_0.png"><img alt="_images/examples-nb_36_0.png" class="pynb" src="_images/examples-nb_36_0.png" style="width: 879px; height: 304px;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">plot_weights</span><span class="p">();</span>
</pre></div>
</div>
<a class="pynb reference internal image-reference" href="_images/examples-nb_37_0.png"><img alt="_images/examples-nb_37_0.png" class="pynb" src="_images/examples-nb_37_0.png" style="width: 888px; height: 289px;" /></a>
<p>So there you have it. Simpler, and more complete.</p>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
        <aside>

            
            <a href="index.html" id="logo" title=bt><img class="logo" src="_static/logo.png" width="150px" height="150px" title=bt /></a>
            
            
            <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html"> Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html"> Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="algos.html"> All About Algos</a></li>
<li class="toctree-l1"><a class="reference internal" href="tree.html"> The Tree Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html"> Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bt.html"> API</a></li>
</ul>


            
            <ul>
                <li><a href="https://github.com/pmorissette/bt">Github</a></li>
            </ul>
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </aside>
    
      <div class="clearer"></div>
    </div>
        <div class="footer">
            bt was created by Philippe Morissette.
If you find a bug, please <a href="https://github.com/pmorissette/bt/issues/new" title="Open a new issue on Github">submit an issue</a> on Github.

        </div>

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-52308448-3', 'auto');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
        
  </body>
</html>